/*
CAKE - Canvas Animation Kit Experiment v1.0.0

Copyright (C) 2007  Ilmari Heikkinen

Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
OTHER DEALINGS IN THE SOFTWARE.
*/
(function(k){var m=k.document;k.requestAnimFrame=function(){return k.requestAnimationFrame||k.webkitRequestAnimationFrame||k.mozRequestAnimationFrame||k.oRequestAnimationFrame||k.msRequestAnimationFrame||function(a){k.setTimeout(a,1E3/60)}}();k.$A||($A=function(a){for(var b=Array(a.length),c=0;c<a.length;c++)b[c]=a[c];return b});k.$||($=function(a){return m.getElementById(a)});var f=function(){_CakeJS=k.CakeJS};Array.prototype.deleteFirst=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return this.splice(b,
1),!0;return!1};Array.prototype.stableSort=function(a){for(var b=0;b<this.length;b++)this[b].__arrayPos=b;return this.sort(Array.__stableSorter(a))};Array.__stableSorter=function(a){return function(b,c){var d=a(b,c);if(!d)return b.__arrayPos-c.__arrayPos;return d}};Array.prototype.equals=function(a){if(!a)return!1;if(this.length!=a.length)return!1;for(var b=0;b<this.length;b++){var c=this[b],d=a[b];if(c.equals&&typeof c.equals=="function"){if(!c.equals(d))return!1}else if(c!=d)return!1}return!0};
Array.prototype.rotate=function(a){return a?(this.unshift(this.pop()),this[0]):(this.push(this.shift()),this[this.length-1])};Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.flatten=function(){for(var a=[],b=0;b<this.length;b++){var c=this[b];if(c.flatten)for(var c=c.flatten(),d=0;d<c.length;d++)a[a.length]=c[d];else a[a.length]=c}return a};Array.prototype.take=function(){for(var a=[],b=0;b<this.length;b++){for(var c=[],d=0;d<arguments.length;d++)c[d]=
this[b][arguments[d]];a[b]=c}return a};if(!Array.prototype.pluck)Array.prototype.pluck=function(a){for(var b=[],c=0;c<this.length;c++)b[c]=this[c][a];return b};Array.prototype.set=function(a,b){for(var c=0;c<this.length;c++)this[c][a]=b};Array.prototype.allWith=function(){var a=[],b=0;a:for(;b<this.length;b++){for(var c=this[b],d=0;d<arguments.length;d++)if(!this[b][arguments[d]])continue a;a[a.length]=c}return a};if(!Array.prototype.last)Array.prototype.last=function(){return this[this.length-1]};
if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(a==this[b])return b;return-1};if(!Array.prototype.includes)Array.prototype.includes=function(a){return this.indexOf(a)>=0};Array.prototype.map=function(a){var b=Array(this.length);if(a)for(var c=0;c<this.length;c++)b[c]=a(this[c],c,this);else for(c=0;c<this.length;c++)b[c]=this[c];return b};Array.prototype.forEach=function(a){for(var b=0;b<this.length;b++)a(this[b],b,this)};if(!Array.prototype.reduce)Array.prototype.reduce=
function(a,b){var c=0;arguments.length==1&&(b=this[0],c++);for(;c<this.length;c++)b=a(b,this[c],c,this);return b};if(!Array.prototype.find)Array.prototype.find=function(a){for(var b=0;b<this.length;b++)if(a(this[b],b,this))return this[b]};if(!Function.prototype.bind)Function.prototype.bind=function(a){var b=this;return function(){return b.apply(a,arguments)}};f.Klass=function(){var a=function(){this.initialize.apply(this,arguments)};a.ancestors=$A(arguments);a.prototype={};for(var b=0;b<arguments.length;b++){var c=
arguments[b];c.prototype?Object.extend(a.prototype,c.prototype):Object.extend(a.prototype,c)}Object.extend(a,a.prototype);return a};if(!Math.sinh)Math.sinh=function(a){return 0.5*(Math.exp(a)-Math.exp(-a))},Math.asinh=function(a){return Math.log(a+Math.sqrt(a*a+1))};if(!Math.cosh)Math.cosh=function(a){return 0.5*(Math.exp(a)+Math.exp(-a))},Math.acosh=function(a){return Math.log(a+Math.sqrt(a*a-1))};Object.forceExtend=function(a,b){for(var c in b)try{a[c]=b[c]}catch(d){}return a};if(!Object.extend)Object.extend=
Object.forceExtend;Object.conditionalExtend=function(a,b){for(var c in b)a[c]==null&&(a[c]=b[c]);return a};Object.clone=function(a){if(!a||a==!0)return a;switch(typeof a){case "string":return Object.extend(a+"",a);case "number":return a;case "function":return obj=eval(a.toSource()),Object.extend(obj,a);case "object":return a instanceof Array?Object.extend([],a):Object.extend({},a)}};Object.loadImage=function(a,b){var c=new Image;if(b)c.onload=b;c.src=a;return c};Object.isImageLoaded=function(a){if(a.tagName==
"CANVAS")return!0;if(!a.complete)return!1;if(a.naturalWidth==null)return!0;return!!a.naturalWidth};Object.sum=function(a,b){if(a instanceof Array)if(b instanceof Array){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]+b[d];return c}else return a.map(function(a){return a+b});else return b instanceof Array?b.map(function(b){return b+a}):a+b};Object.sub=function(a,b){if(a instanceof Array)if(b instanceof Array){for(var c=[],d=0;d<a.length;d++)c[d]=a[d]-b[d];return c}else return a.map(function(a){return a-b});
else return b instanceof Array?b.map(function(b){return a-b}):a-b};if(!String.prototype.capitalize)String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())};if(!String.prototype.escape)String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'};if(!String.prototype.splice)String.prototype.splice=function(a,b,c){return this.slice(0,a)+c+this.slice(a+b)};if(!String.prototype.strip)String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,
"")};f.Animatable=f.Klass({tweenFunctions:{linear:function(a){return a},set:function(a){return Math.floor(a)},discrete:function(a){return Math.floor(a)},sine:function(a){return 0.5-0.5*Math.cos(a*Math.PI)},sproing:function(a){return(0.5-0.5*Math.cos(a*3.59261946538606))*1.05263157894737},square:function(a){return a*a},cube:function(a){return a*a*a},sqrt:function(a){return Math.sqrt(a)},curt:function(a){return Math.pow(a,-0.333333333333)}},initialize:function(){this.lastAction=0;this.timeline=[];this.keyframes=
[];this.pendingKeyframes=[];this.pendingTimelineEvents=[];this.timelines=[];this.animators=[];this.addFrameListener(this.updateTimelines);this.addFrameListener(this.updateKeyframes);this.addFrameListener(this.updateTimeline);this.addFrameListener(this.updateAnimators)},updateTimelines:function(a,b){for(var c=0;c<this.timelines.length;c++)this.timelines[c].evaluate(this,a,b)},addTimeline:function(a){this.timelines.push(a)},removeTimeline:function(a){this.timelines.deleteFirst(a)},updateKeyframes:function(a){this.addPendingKeyframes(a);
if(this.keyframes.length>0){for(var b,c,d,e=0;e<this.keyframes.length;e++)if(this.keyframes[e].time>a){b=e;break}b!=null&&(c=this.keyframes[b-1],d=this.keyframes[b]);if(d){if(c){this.keyframes.atEnd=!1;var a=(a-c.time)/(d.time-c.time),g;for(g in d.target)c.target[g]!=null&&this.tweenVariable(g,c.target[g],d.target[g],a,d.tween)}}else if(!this.keyframes.atEnd)this.keyframes.atEnd=!0,c=this.keyframes[this.keyframes.length-1],Object.extend(this,Object.clone(c.target)),this.changed=!0}},addPendingKeyframes:function(a){if(this.pendingKeyframes.length>
0){for(;this.pendingKeyframes.length>0;){var b=this.pendingKeyframes.shift();if(b.time==null)b.time=b.relativeTime+a;this.keyframes.push(b)}this.keyframes.stableSort(function(a,b){return a.time-b.time})}},updateTimeline:function(a,b){for(this.addPendingTimelineEvents(a);this.timeline[0]&&this.timeline[0].startTime<=a;){var c=this.timeline.shift(),d=!0;typeof c.action=="function"?d=c.action.call(this,a,b,c):this.animators.push(c.action);if(c.repeatEvery!=null&&d!=!1){if(c.repeatTimes!=null){if(c.repeatTimes<=
0)continue;c.repeatTimes--}c.startTime+=c.repeatEvery;this.addTimelineEvent(c)}this.changed=!0}},addPendingTimelineEvents:function(a){if(this.pendingTimelineEvents.length>0){for(;this.pendingTimelineEvents.length>0;){var b=this.pendingTimelineEvents.shift();if(!b.startTime)b.startTime=b.relativeStartTime+a;this.timeline.push(b)}this.timeline.stableSort(function(a,b){return a.startTime-b.startTime})}},addTimelineEvent:function(a){this.pendingTimelineEvents.push(a)},updateAnimators:function(a){for(var b=
0;b<this.animators.length;b++){var c=this.animators[b];if(!c.startTime)c.startTime=a;var d=(a-c.startTime)/c.duration,e=!1;if(d>=1)if(c.repeat){if(c.repeat!==!0)c.repeat=Math.max(0,c.repeat-1);if(c.accumulate)c.startValue=Object.clone(c.endValue),c.endValue=Object.sum(c.difference,c.endValue);c.repeat==0?(e=!0,d=1):(c.startTime=a,d%=1)}else d=1,e=!0;else if(c.repeat&&c.repeat!==!0&&c.repeat<=d)e=!0,d=c.repeat;this.tweenVariable(c.variable,c.startValue,c.endValue,d,c.tween);e&&(this.animators.splice(b,
1),b--)}},tweenVariable:function(a,b,c,d,e){typeof e!="function"&&(e=this.tweenFunctions[e]||this.tweenFunctions.linear);d=e(d);if(typeof a!="function")if(b instanceof Array)for(e=0;e<b.length;e++)this[a][e]=b[e]+d*(c[e]-b[e]);else this[a]=b+d*(c-b);else a.call(this,d,b,c);this.changed=!0},animate:function(a,b,c,d,e,g){b=Object.clone(b);c=Object.clone(c);g||(g={});if(g.additive)var j=Object.sub(c,b),b=Object.sum(b,this[a]),c=Object.sum(c,this[a]);typeof a!="function"&&(this[a]=Object.clone(b));a=
{id:f.Animatable.uid++,variable:a,startValue:b,endValue:c,difference:j,duration:d,tween:e,repeat:g.repeat,additive:g.additive,accumulate:g.accumulate,pingpong:g.pingpong};this.animators.push(a);return a},removeAnimator:function(a){this.animators.deleteFirst(a)},animateTo:function(a,b,c,d,e){return this.animate(a,this[a],b,c,d,e)},animateFrom:function(a,b,c,d,e){return this.animate(a,b,this[a],c,d,e)},animateFactor:function(a,b,c,d,e,g){var j;if(b instanceof Array){j=[];for(var i=0;i<b.length;i++)j[i]=
b[i]*c}else j=b*c;return this.animate(a,b,j,d,e,g)},animateToFactor:function(a,b,c,d,e){return this.animateFactor(a,this[a],b,c,d,e)},addKeyframe:function(a,b,c){this.pendingKeyframes.push({relativeTime:a,target:b,tween:c})},addKeyframeAt:function(a,b,c){this.pendingKeyframes.push({time:a,target:b,tween:c})},appendKeyframe:function(a,b,c){this.lastAction+=a;return this.addKeyframe(this.lastAction,b,c)},every:function(a,b,c){a={action:b,relativeStartTime:c?a:0,repeatEvery:a};this.addTimelineEvent(a);
return a},at:function(a,b){var c={action:b,startTime:a};this.addTimelineEvent(c);return c},after:function(a,b){var c={action:b,relativeStartTime:a};this.addTimelineEvent(c);return c},afterFrame:function(a,b){var c=0,d;d=function(){c>=a&&(b.call(this),this.removeFrameListener(d));c++};this.addFrameListener(d);return d},everyFrame:function(a,b,c){var d=c?0:a,e;e=function(){d>=a&&(b.call(this)==!1&&this.removeFrameListener(e),d=0);d++};this.addFrameListener(e);return e}});f.Animatable.uid=0;f.CanvasSupport=
{DEVICE_SPACE:0,USER_SPACE:1,isPointInPathMode:null,supportsIsPointInPath:null,supportsCSSTransform:null,supportsCanvas:null,isCanvasSupported:function(){if(this.supportsCanvas==null){var a={};try{a=E("canvas")}catch(b){}this.supportsCanvas=a.getContext!=null}return this.supportsCanvas},isCSSTransformSupported:function(){if(this.supportsCSSTransform==null){var a=E("div").style;this.supportsCSSTransform=(a.webkitTransform!=null||a.MozTransform!=null)!=null}return this.supportsCSSTransform},getTestContext:function(){if(!this.testContext)this.testContext=
E.canvas(1,1).getContext("2d");return this.testContext},getSupportsAudioTag:function(){return!!E("audio").play},getSupportsSoundManager:function(){return k.soundManager&&soundManager.enabled},soundId:0,getSoundObject:function(){var a=null;this.getSupportsSoundManager()&&(a=this.getSoundManagerSoundObject());return a},getAudioTagSoundObject:function(){var a="sound-"+this.soundId++,a=E("audio",{id:a});a.load=function(a){this.src=a};a.addEventListener("canplaythrough",function(){if(this.onready)this.onready()},
!1);a.setVolume=function(a){this.volume=a};a.setPan=function(a){this.pan=a};return a},getSoundManagerSoundObject:function(){var a="sound-"+this.soundId++,b={volume:100,pan:0,sid:a,load:function(a){return soundManager.load(this.sid,{url:a,autoPlay:!1,volume:this.volume,pan:this.pan})},_onload:function(){if(this.onload)this.onload();if(this.onready)this.onready()},_onerror:function(){if(this.onerror)this.onerror()},_onfinish:function(){if(this.onfinish)this.onfinish()},play:function(){return soundManager.play(this.sid)},
stop:function(){return soundManager.stop(this.sid)},pause:function(){return soundManager.togglePause(this.sid)},setVolume:function(a){this.volume=a*100;return soundManager.setVolume(this.sid,a*100)},setPan:function(a){this.pan=a*100;return soundManager.setPan(this.sid,a*100)}};soundManager.createSound(a,"null.mp3");b.sound=soundManager.getSoundById(a);b.sound.options.onfinish=b._onfinish.bind(b);b.sound.options.onload=b._onload.bind(b);b.sound.options.onerror=b._onerror.bind(b);return b},ContextSetterAugment:{setFillStyle:function(a){this.fillStyle=
a},setStrokeStyle:function(a){this.strokeStyle=a},setGlobalAlpha:function(a){this.globalAlpha=a},setLineWidth:function(a){this.lineWidth=a},setLineCap:function(a){this.lineCap=a},setLineJoin:function(a){this.lineJoin=a},setMiterLimit:function(a){this.miterLimit=a},setGlobalCompositeOperation:function(a){this.globalCompositeOperation=a},setShadowColor:function(a){this.shadowColor=a},setShadowBlur:function(a){this.shadowBlur=a},setShadowOffsetX:function(a){this.shadowOffsetX=a},setShadowOffsetY:function(a){this.shadowOffsetY=
a},setMozTextStyle:function(a){this.mozTextStyle=a},setFont:function(a){this.font=a},setTextAlign:function(a){this.textAlign=a},setTextBaseline:function(a){this.textBaseline=a}},ContextJSImplAugment:{identity:function(){f.CanvasSupport.setTransform(this,[1,0,0,1,0,0])}},augment:function(a){Object.conditionalExtend(a,this.ContextSetterAugment);Object.conditionalExtend(a,this.ContextJSImplAugment);return a},getContext:function(a,b){var c=a.getContext(b||"2d");this.augment(c);return c},tMatrixMultiply:function(a,
b){var c=a[1]*b[0]+a[3]*b[1],d=a[0]*b[2]+a[2]*b[3],e=a[1]*b[2]+a[3]*b[3],g=a[0]*b[4]+a[2]*b[5]+a[4],j=a[1]*b[4]+a[3]*b[5]+a[5];a[0]=a[0]*b[0]+a[2]*b[1];a[1]=c;a[2]=d;a[3]=e;a[4]=g;a[5]=j;return a},tMatrixMultiplyPoint:function(a,b,c){return[b*a[0]+c*a[2]+a[4],b*a[1]+c*a[3]+a[5]]},tInvertMatrix:function(a){var b=1/(a[0]*a[3]-a[1]*a[2]);return[a[3]*b,-a[1]*b,-a[2]*b,a[0]*b,b*(a[2]*a[5]-a[3]*a[4]),b*(a[1]*a[4]-a[0]*a[5])]},transform:function(a,b){if(a.transform)return a.transform.apply(a,b);a.translate(b[4],
b[5]);if(Math.abs(b[1])<1.0E-6&&Math.abs(b[2])<1.0E-6)a.scale(b[0],b[3]);else{var c=this.svdTransform({xx:b[0],xy:b[2],yx:b[1],yy:b[3],dx:b[4],dy:b[5]});a.rotate(c.angle2);a.scale(c.sx,c.sy);a.rotate(c.angle1)}},brokenSvd:function(a){var b=[a[0],a[2],a[1],a[3],0,0],c=[b[0]*a[0]+b[2]*a[1],b[1]*a[0]+b[3]*a[1],b[0]*a[2]+b[2]*a[3],b[1]*a[2]+b[3]*a[3],0,0],b=-(c[0]+c[3]),d=Math.sqrt(b*b-4*(-(c[1]*c[2])+c[0]*c[3])),e=(-b+d)/2,d=(-b-d)/2;e<d&&(b=e,e=d,d=b);var b=Math.sqrt(e),d=Math.sqrt(d),g=[1/b,0,0,1/
d,0,0],e=(c[0]-e)/c[2],j=Math.sqrt(1+e*e),c=1/j;e/=j;var j=-e,i=[c,j,e,c,0,0],a=a.slice(0);this.tMatrixMultiply(a,i);this.tMatrixMultiply(a,g);return[a,[b,0,0,d,0,0],[c,e,j,c,0,0]]},svdTransform:function(){var a={};a.Matrix2D=function(b){if(b)if(typeof b=="number")this.xx=this.yy=b;else if(b instanceof Array){if(b.length>0){for(var c=a.normalize(b[0]),e=1;e<b.length;++e){var d=c,g=a.normalize(b[e]),c=new a.Matrix2D;c.xx=d.xx*g.xx+d.xy*g.yx;c.xy=d.xx*g.xy+d.xy*g.yy;c.yx=d.yx*g.xx+d.yy*g.yx;c.yy=d.yx*
g.xy+d.yy*g.yy;c.dx=d.xx*g.dx+d.xy*g.dy+d.dx;c.dy=d.yx*g.dx+d.yy*g.dy+d.dy}Object.extend(this,c)}}else Object.extend(this,b)};a.normalize=function(b){return b instanceof a.Matrix2D?b:new a.Matrix2D(b)};a.multiply=function(b){for(var c=a.normalize(b),d=1;d<arguments.length;++d){var e=c,g=a.normalize(arguments[d]),c=new a.Matrix2D;c.xx=e.xx*g.xx+e.xy*g.yx;c.xy=e.xx*g.xy+e.xy*g.yy;c.yx=e.yx*g.xx+e.yy*g.yx;c.yy=e.yx*g.xy+e.yy*g.yy;c.dx=e.xx*g.dx+e.xy*g.dy+e.dx;c.dy=e.yx*g.dx+e.yy*g.dy+e.dy}return c};
a.invert=function(b){var b=a.normalize(b),c=b.xx*b.yy-b.xy*b.yx;return b=new a.Matrix2D({xx:b.yy/c,xy:-b.xy/c,yx:-b.yx/c,yy:b.xx/c,dx:(b.xy*b.dy-b.yy*b.dx)/c,dy:(b.yx*b.dx-b.xx*b.dy)/c})};Object.extend(a.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var b=function(a,b){return Math.abs(a-b)<=1.0E-6*(Math.abs(a)+Math.abs(b))},c=function(a,b){if(isFinite(a)){if(!isFinite(b))return a}else return b;return(a+b)/2},d=function(c){var c=a.normalize(c),e=-c.xx-c.yy,d=c.xx*c.yy-c.xy*c.yx,g=Math.sqrt(e*e-4*d),e=
-(e+(e<0?-g:g))/2;d/=e;var g=c.xy/(e-c.xx),f=1,k=c.xy/(d-c.xx),n=1;b(e,d)&&(g=1,k=f=0,n=1);isFinite(g)||(g=1,f=(e-c.xx)/c.xy,isFinite(f)||(g=(e-c.yy)/c.yx,f=1,isFinite(g)||(g=1,f=c.yx/(e-c.yy))));isFinite(k)||(k=1,n=(d-c.xx)/c.xy,isFinite(n)||(k=(d-c.yy)/c.yx,n=1,isFinite(k)||(k=1,n=c.yx/(d-c.yy))));var c=Math.sqrt(g*g+f*f),m=Math.sqrt(k*k+n*n);if(isNaN(g/=c))g=0;if(isNaN(f/=c))f=0;if(isNaN(k/=m))k=0;if(isNaN(n/=m))n=0;return{value1:e,value2:d,vector1:{x:g,y:f},vector2:{x:k,y:n}}},e=function(a,b){var e=
a.xx*a.yy<0||a.xy*a.yx>0?-1:1,d=b.angle1=(Math.atan2(a.yx,a.yy)+Math.atan2(-e*a.xy,e*a.xx))/2,e=Math.cos(d),d=Math.sin(d);b.sx=c(a.xx/e,-a.xy/d);b.sy=c(a.yy/e,a.yx/d);return b},g=function(a,b){var e=a.xx*a.yy<0||a.xy*a.yx>0?-1:1,d=b.angle2=(Math.atan2(e*a.yx,e*a.xx)+Math.atan2(-a.xy,a.yy))/2,e=Math.cos(d),d=Math.sin(d);b.sx=c(a.xx/e,a.yx/d);b.sy=c(a.yy/e,-a.xy/d);return b};return function(c){var f=a.normalize(c),c={dx:f.dx,dy:f.dy,sx:1,sy:1,angle1:0,angle2:0};if(b(f.xy,0)&&b(f.yx,0))return Object.extend(c,
{sx:f.xx,sy:f.yy});if(b(f.xx*f.yx,-f.xy*f.yy))return e(f,c);if(b(f.xx*f.xy,-f.yx*f.yy))return g(f,c);var h,l=new a.Matrix2D(f);h=Object.extend(l,{dx:0,dy:0,xy:l.yx,yx:l.xy});l=d([f,h]);h=d([h,f]);l=new a.Matrix2D({xx:l.vector1.x,xy:l.vector2.x,yx:l.vector1.y,yy:l.vector2.y});h=new a.Matrix2D({xx:h.vector1.x,xy:h.vector1.y,yx:h.vector2.x,yy:h.vector2.y});f=new a.Matrix2D([a.invert(l),f,a.invert(h)]);e(h,c);f.xx*=c.sx;f.yy*=c.sy;g(l,c);f.xx*=c.sx;f.yy*=c.sy;return Object.extend(c,{sx:f.xx,sy:f.yy})}}(),
setTransform:function(a,b,c){if(a.setTransform)return a.setTransform.apply(a,b);this.transform(a,this.tInvertMatrix(c));this.transform(a,b)},skewX:function(a,b){return this.transform(a,this.tSkewXMatrix(b))},skewY:function(a,b){return this.transform(a,this.tSkewYMatrix(b))},tRotate:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=a[1]*c+a[3]*d,g=a[0]*-d+a[2]*c,f=a[1]*-d+a[3]*c;a[0]=a[0]*c+a[2]*d;a[1]=e;a[2]=g;a[3]=f;return a},tTranslate:function(a,b,c){a[4]+=a[0]*b+a[2]*c;a[5]+=a[1]*b+a[3]*c;return a},
tScale:function(a,b,c){a[0]*=b;a[1]*=b;a[2]*=c;a[3]*=c;return a},tSkewX:function(a,b){return this.tMatrixMultiply(a,this.tSkewXMatrix(b))},tSkewY:function(a,b){return this.tMatrixMultiply(a,this.tSkewYMatrix(b))},tSkewXMatrix:function(a){return[1,0,Math.tan(a),1,0,0]},tSkewYMatrix:function(a){return[1,Math.tan(a),0,1,0,0]},tRotationMatrix:function(a){var b=Math.cos(a),a=Math.sin(a);return[b,a,-a,b,0,0]},tTranslationMatrix:function(a,b){return[1,0,0,1,a,b]},tScalingMatrix:function(a,b){return[a,0,
0,b,0,0]},getTextBackend:function(){if(this.textBackend==null)this.textBackend=this.detectTextBackend();return this.textBackend},detectTextBackend:function(){var a=this.getTestContext();if(a.fillText)return"HTML5";else if(a.mozDrawText)return"MozText";else if(a.drawString)return"DrawString";return"NONE"},getSupportsPutImageData:function(){if(this.supportsPutImageData==null){var a=this.getTestContext(),b=a.putImageData;if(b)try{var c=a.getImageData(0,0,1,1);c[0]=255;c[1]=0;c[2]=255;c[3]=255;a.putImageData({width:1,
height:1,data:c},0,0);c=a.getImageData(0,0,1,1);b=[255,0,255,255].equals(c.data)}catch(d){b=!1}this.supportsPutImageData=b}return b},getSupportsIsPointInPath:function(){if(this.supportsIsPointInPath==null)this.supportsIsPointInPath=!!this.getTestContext().isPointInPath;return this.supportsIsPointInPath},getIsPointInPathMode:function(){if(this.isPointInPathMode==null)this.isPointInPathMode=this.detectIsPointInPathMode();return this.isPointInPathMode},detectIsPointInPathMode:function(){var a=this.getTestContext(),
b;if(!a.isPointInPath)return this.USER_SPACE;a.save();a.translate(1,0);a.beginPath();a.rect(0,0,1,1);b=a.isPointInPath(0.3,0.3)?this.USER_SPACE:this.DEVICE_SPACE;a.restore();return b},isPointInPath:function(a,b,c,d,e){return a.isPointInPath?(this.getIsPointInPathMode()==this.USER_SPACE?a.setTransform?(a.save(),a.setTransform(1,0,0,1,0,0),e=a.isPointInPath(b,c),a.restore()):(b=this.tMatrixMultiplyPoint(this.tInvertMatrix(d),b,c),e=a.isPointInPath(b[0],b[1])):e=a.isPointInPath(b,c),e):e&&e.isPointInPath?
(b=this.tMatrixMultiplyPoint(this.tInvertMatrix(d),b,c),e.isPointInPath(b[0],b[1])):!1}};f.Colors={hsl2rgb:function(a,b,c){var d;if(b==0)a=d=b=v;else{var b=c<0.5?c*(1+b):c+b-c*b,c=2*c-b,e=a%360/360,a=e+1/3;d=e;e-=1/3;a<0&&a++;a>1&&a--;d<0&&d++;d>1&&d--;e<0&&e++;e>1&&e--;a=a<1/6?c+(b-c)*6*a:a<0.5?b:a<2/3?c+(b-c)*6*(2/3-a):c;d=d<1/6?c+(b-c)*6*d:d<0.5?b:d<2/3?c+(b-c)*6*(2/3-d):c;b=e<1/6?c+(b-c)*6*e:e<0.5?b:e<2/3?c+(b-c)*6*(2/3-e):c}return[a,d,b]},hsv2rgb:function(a,b,c){var d,e,g;if(b==0)d=e=g=c;else{var a=
a%360/60,f=Math.floor(a),i=a-f,a=c*(1-b),h=c*(1-b*i),b=c*(1-b*(1-i));switch(f){case 0:d=c;e=b;g=a;break;case 1:d=h;e=c;g=a;break;case 2:d=a;e=c;g=b;break;case 3:d=a;e=h;g=c;break;case 4:d=b;e=a;g=c;break;case 5:d=c,e=a,g=h}}return[d,e,g]},parseColorStyle:function(a,b){if(typeof a=="string")return a;else if(a.compiled)return a.compiled;else if(a.isPattern)return a.compile(b);else if(a.length==3)return"rgba("+a.map(Math.round).join(",")+", 1)";else if(a.length==4)return"rgba("+Math.round(a[0])+","+
Math.round(a[1])+","+Math.round(a[2])+","+a[3]+")";else throw"Bad style: "+a;}};f.Curves={angularDistance:function(a,b){var c=Math.PI*2,d=(b-a)%c;d>Math.PI&&(d-=c);d<-Math.PI&&(d+=c);return d},linePoint:function(a,b,c){return[a[0]+(b[0]-a[0])*c,a[1]+(b[1]-a[1])*c]},quadraticPoint:function(a,b,c,d){var e=a[0]+(b[0]-a[0])*d,a=a[1]+(b[1]-a[1])*d;return[e+(b[0]+(c[0]-b[0])*d-e)*d,a+(b[1]+(c[1]-b[1])*d-a)*d]},cubicPoint:function(a,b,c,d,e){var g=a[0]*3,f=b[0]*3,i=c[0]*3,h=a[1]*3,b=b[1]*3,c=c[1]*3;return[a[0]+
e*(f-g+e*(g-2*f+i+e*(f-a[0]-i+d[0]))),a[1]+e*(b-h+e*(h-2*b+c+e*(b-a[1]-c+d[1])))]},linearValue:function(a,b,c){return a+(b-a)*c},quadraticValue:function(a,b,c,d){a+=(b-a)*d;return a+(b+(c-b)*d-a)*d},cubicValue:function(a,b,c,d,e){var g=a*3;b*=3;c*=3;return a+e*(b-g+e*(g-2*b+c+e*(b-a-c+d)))},catmullRomPoint:function(a,b,c,d,e){var g=((-e+2)*e-1)*e*0.5,f=((3*e-5)*e*e+2)*0.5,i=((-3*e+4)*e+1)*e*0.5,e=(e-1)*e*e*0.5;return[a[0]*g+b[0]*f+c[0]*i+d[0]*e,a[1]*g+b[1]*f+c[1]*i+d[1]*e]},catmullRomAngle:function(a,
b,c,d,e){return Math.atan2(0.5*(c[1]-a[1]+2*e*(2*a[1]-5*b[1]+4*c[1]-d[1])+3*e*e*(3*b[1]+d[1]-a[1]-3*c[1])),0.5*(c[0]-a[0]+2*e*(2*a[0]-5*b[0]+4*c[0]-d[0])+3*e*e*(3*b[0]+d[0]-a[0]-3*c[0])))},catmullRomPointAngle:function(a,b,c,d,e){var g=this.catmullRomPoint(a,b,c,d,e),a=this.catmullRomAngle(a,b,c,d,e);return{point:g,angle:a}},lineAngle:function(a,b){return Math.atan2(b[1]-a[1],b[0]-a[0])},quadraticAngle:function(a,b,c,d){a=this.linePoint(a,b,d);b=this.linePoint(b,c,d);return this.lineAngle(a,b)},cubicAngle:function(a,
b,c,d,e){a=this.quadraticPoint(a,b,c,e);b=this.quadraticPoint(b,c,d,e);return this.lineAngle(a,b)},lineLength:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},squareLineLength:function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},quadraticLength:function(a,b,c,d){var e=this.linePoint(a,b,2/3),b=this.linePoint(b,c,1/3);return this.cubicLength(a,e,b,c,d)},cubicLength:function(){var a=function(b,c){for(var d=0,e=0;e<3;e++)d+=f.Curves.lineLength(b[e],b[e+1]);e=f.Curves.lineLength(b[0],
b[3]);if(d-e>c){for(var d=[b.slice(0)],g=1;g<4;g++){d[g]=[[],[],[],[]];for(e=0;e<4-g;e++)d[g][e][0]=0.5*(d[g-1][e][0]+d[g-1][e+1][0]),d[g][e][1]=0.5*(d[g-1][e][1]+d[g-1][e+1][1])}for(var g=[],j=[],e=0;e<4;e++)g[e]=d[e][0],j[e]=d[3-e][e];d=[g,j];d=a(d[0],c)+a(d[1],c)}return d};return function(b,c,d,e,g){g||(g=1);return a([b,c,d,e],g)}}(),quadraticLengthPointAngle:function(a,b,c,d,e){d=this.linePoint(a,b,2/3);b=this.linePoint(b,c,1/3);return this.cubicLengthPointAngle(a,d,b,c,e)},cubicLengthPointAngle:function(a,
b,c,d,e,g){var f=this.cubicLength(a,b,c,d,g),i=g=a,h=0,l=0;f*=e;for(e=1;e<=20;e++)if(i=g,g=this.cubicPoint(a,b,c,d,0.05*e),h=l,l+=this.lineLength(i,g),l>=f){if(l==h)return{point:g,angle:this.lineAngle(a,b)};h=(l-f)/(l-h);return{point:this.linePoint(i,g,1-h),angle:this.cubicAngle(a,b,c,d,0.05*(e-h))}}return{point:d.slice(0),angle:this.lineAngle(c,d)}}};E=function(a,b,c){a=m.createElement(a);if(b&&(typeof b=="string"?(a.innerHTML=b,b=c):b.DOCUMENT_NODE&&(a.appendChild(b),b=c),b)){if(b.style)c=b.style,
b=Object.clone(b),delete b.style,Object.forceExtend(a.style,c);b.content&&(typeof b.content=="string"?a.appendChild(T(b.content)):a.appendChild(b.content),b=Object.clone(b),delete b.content);Object.forceExtend(a,b)}return a};E.append=function(a){for(var b=1;b<arguments.length;b++)typeof arguments[b]=="string"?a.appendChild(T(arguments[b])):a.appendChild(arguments[b])};E.lastCanvasId=0;E.canvas=function(a,b,c){var d="canvas-uuid-"+E.lastCanvasId;E.lastCanvasId++;c||(c={});return E("canvas",Object.extend(c,
{id:d,width:a,height:b}))};f.Gradient=f.Klass({type:"linear",isPattern:!0,startX:0,startY:0,endX:1,endY:0,startRadius:0,endRadius:1,colorStops:[],initialize:function(a){this.colorStops=[[0,"#000000"],[1,"#FFFFFF"]];a&&Object.extend(this,a)},compile:function(a){for(var a=this.type=="linear"?a.createLinearGradient(this.startX,this.startY,this.endX,this.endY):a.createRadialGradient(this.startX,this.startY,this.startRadius,this.endX,this.endY,this.endRadius),b=0;b<this.colorStops.length;b++){var c=this.colorStops[b];
if(typeof c[1]=="string")a.addColorStop(c[0],c[1]);else{var d=c[1],e=d.length==3?1:d[3],d="rgba("+d.slice(0,3).map(Math.round).join(",")+", "+e+")";a.addColorStop(c[0],d)}}Object.extend(a,f.Transformable.prototype);a.transformList=this.transformList;a.scale=this.scale;a.x=this.x;a.y=this.y;a.matrix=this.matrix;a.rotation=this.rotation;a.units=this.units;if(!a.isMockObject)this.compiled=a;return a}});f.Mouse={LEFT:0,MIDDLE:1,RIGHT:2};f.Mouse.getRelativeCoords=function(a,b){for(var c={x:0,y:0},d=0,
e=0,g=a;g;)d+=g.offsetLeft,e+=g.offsetTop,g=g.offsetParent;c.x=b.pageX-d;c.y=b.pageY-e;return c};f.Browser=function(){var a=k.navigator.userAgent,b=a.match(/KHTML/),c=a.match(/Gecko/),d=a.match(/WebKit\/\d+/),a=a.match(/Explorer/);if(b)return"KHTML";if(c)return"Gecko";if(d)return"Webkit";if(a)return"IE";return"UNKNOWN"}();if(f.Browser=="IE")f.Mouse.LEFT=1,f.Mouse.MIDDLE=4;f.Pattern=f.Klass({isPattern:!0,repeat:"repeat",initialize:function(a,b){this.image=a;if(b)this.repeat=b},compile:function(a){a=
a.createPattern(this.image,this.repeat);Object.extend(a,f.Transformable.prototype);a.transformList=this.transformList;a.scale=this.scale;a.x=this.x;a.y=this.y;a.matrix=this.matrix;a.rotation=this.rotation;a.units=this.units;if(!a.isMockObject)this.compiled=a;return a}});f.RecordingContext=f.Klass({objectId:0,commands:[],isMockObject:!0,initialize:function(a){this.commands=a||[];Object.conditionalExtend(this,this.getMockContext())},getMockContext:function(){if(!f.RecordingContext.MockContext){var a=
E.canvas(1,1),a=f.CanvasSupport.getContext(a,"2d"),b={},c;for(c in a)b[c]=typeof a[c]=="function"?this.createRecordingFunction(c):a[c];b.isPointInPath=null;b.transform=null;b.setTransform=null;f.RecordingContext.MockContext=b}return f.RecordingContext.MockContext},createRecordingFunction:function(a){if(a.search(/^set[A-Z]/)!=-1&&a!="setTransform"){var b=a.charAt(3).toLowerCase()+a.slice(4);return function(){this[b]=arguments[0];this.commands.push([a,$A(arguments)])}}else return function(){this.commands.push([a,
$A(arguments)])}},clear:function(){this.commands=[]},getRecording:function(){return this.commands},serialize:function(a,b){return"("+{width:a,height:b,commands:this.getRecording()}.toSource()+")"},play:function(a){f.RecordingContext.play(a,this.getRecording())},createLinearGradient:function(){var a=this.objectId++;this.commands.push([a,"=","createLinearGradient",$A(arguments)]);return new MockGradient(this,a)},createRadialGradient:function(){var a=this.objectId++;this.commands.push([a,"=","createRadialGradient",
$A(arguments)]);return new this.MockGradient(this,a)},createPattern:function(){var a=this.objectId++;this.commands.push([a,"=","createPattern",$A(arguments)]);return new this.MockGradient(this,a)},MockGradient:f.Klass({isMockObject:!0,initialize:function(a,b){this.recorder=a;this.id=b},addColorStop:function(){this.recorder.commands.push([this.id,"addColorStop",$A(arguments)])},toSource:function(){return{id:this.id,isMockObject:!0}.toSource()}})});f.RecordingContext.play=function(a,b){for(var c=[],
d=0;d<b.length;d++){var e=b[d];if(e.length==2){var g=e[1];if(g[0]&&g[0].isMockObject)a[e[0]](c[g[0].id]);else a[e[0]].apply(a,e[1])}else if(e.length==3)g=c[e[0]],g[e[1]].apply(g,e[2]);else if(e.length==4)c[e[0]]=a[e[2]].apply(a,e[3]);else throw"Malformed command: "+e.toString();}};f.SVGParser={load:function(a,b){if(!b.onSuccess)throw"Need to provide an onSuccess function.";if(!b.filename)b.filename=a;var c=k.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");c.open("GET",a,
!0);c.overrideMimeType("text/xml");var d=!1;c.onreadystatechange=function(){if(c.readyState==4)if(c.status==200||c.status==0){try{var e=c.responseXML,j=f.SVGParser.parse(e,b);j.svgRootElement=e}catch(i){if(b.onFailure)b.onFailure(c,i,a,b);return}b.onSuccess(j,c,a,b)}else{if(b.onFailure&&!d)b.onFailure(c,null,a,b)}else if(c.readyState==3&&b.onLoading)b.onLoading(c,a,b)};try{c.send(null)}catch(e){b.onFailure&&(b.onFailure(c,e,a,b),d=!0),c.abort()}},parse:function(a,b){var c=new f.CanvasNode,d=b.width,
e=b.height,g=b.fontSize;c.innerWidth=d||k.innerWidth;c.innerHeight=e||k.innerHeight;c.innerSize=Math.sqrt(d*d+e*e)/Math.sqrt(2);c.fontSize=g||12;c.filename=b.filename||".";d={};e={ids:{},classes:{},tags:{}};c.color=b.currentColor||"black";this.parseChildren(a,c,d,e);c.defs=d;c.style=e;return c},parsePreserveAspectRatio:function(a,b,c,d,e){var g=(a||"").split(/\s+/);g[0]=="defer"&&g.shift();var f=g[0]||"xMidYMid",i=b/d,h=c/e,a={x:0,y:0,w:i,h:h};if(f=="none")return a;a.w=a.h=((g[1]||"meet")=="meet"?
Math.min:Math.max)(i,h);g=f.slice(1,4).toLowerCase();f=this.SVGAlignMap[f.slice(5,8).toLowerCase()]||0;a.x=(this.SVGAlignMap[g]||0)*(b-d*a.w);a.y=f*(c-e*a.h);return a},SVGAlignMap:{min:0,mid:0.5,max:1},SVGTagMapping:{svg:function(a,b){var c=new f.Rectangle;c.width=0;c.height=0;c.doFill=function(){};c.doStroke=function(){};c.drawMarkers=function(){};c.fill="black";c.stroke="none";var d=a.getAttribute("viewBox"),e=a.getAttribute("width"),g=a.getAttribute("height");e?g||(g=e):e=g;if(e)var j=this.parseUnit(e,
b,"x"),i=this.parseUnit(g,b,"y");if(d){xywh=d.match(/[-+]?\d+/g).map(parseFloat);c.cx=xywh[0];c.cy=xywh[1];c.width=xywh[2];c.height=xywh[3];var g=b.innerWidth=c.width,h=b.innerHeight=c.height;b.innerSize=Math.sqrt(g*g+h*h)/Math.sqrt(2);if(a.getAttribute("overflow")!="visible")c.clip=!0}if(e){if(d)d=this.parsePreserveAspectRatio(a.getAttribute("preserveAspectRatio"),j,i,c.width,c.height),c.cx-=d.x/d.w,c.cy-=d.y/d.h,c.width=j/d.w,c.height=i/d.h,c.x+=d.x,c.y+=d.y,c.scale=[d.w,d.h];b.docWidth=j;b.docHeight=
i}return c},marker:function(a,b){var c=new f.CanvasNode;c.draw=function(a){this.overflow!="hidden"&&this.viewBox||(a.beginPath(),a.rect(this.viewBox[0],this.viewBox[1],this.viewBox[2],this.viewBox[3]),a.clip())};var d=-this.parseUnit(a.getAttribute("refX"),b,"x")||0,e=-this.parseUnit(a.getAttribute("refY"),b,"y")||0;c.transformList=[["translate",[d,e]]];c.markerUnits=a.getAttribute("markerUnits")||"strokeWidth";c.markerWidth=this.parseUnit(a.getAttribute("markerWidth"),b,"x")||3;c.markerHeight=this.parseUnit(a.getAttribute("markerHeight"),
b,"y")||3;c.overflow=a.getAttribute("overflow")||"hidden";c.viewBox=a.getAttribute("viewBox");c.orient=a.getAttribute("orient")||0;if(c.orient&&c.orient!="auto")c.orient=parseFloat(c.orient)*SVGMapping.DEG_TO_RAD_FACTOR;if(c.viewBox)c.viewBox=c.viewBox.strip().split(/[\s,]+/g).map(parseFloat),d=c.viewBox[2]-c.viewBox[0],e=c.viewBox[3]-c.viewBox[1],c.markerWidth&&(d=sy=Math.min(c.markerWidth/d,c.markerHeight/e),c.transformList.unshift(["scale",[d,sy]]));return c},clipPath:function(a){var b=new f.CanvasNode;
b.units=a.getAttribute("clipPathUnits");return b},title:function(a,b){b.root.title=a.textContent},desc:function(a,b){b.root.description=a.textContent},metadata:function(a,b){b.root.metadata=a},parseAnimateTag:function(a,b){var c=f.SVGParser.SVGTagMapping.parseTime(a.getAttribute("begin")),d=f.SVGParser.SVGTagMapping.parseTime(a.getAttribute("dur")),e=f.SVGParser.SVGTagMapping.parseTime(a.getAttribute("end"));d==null&&(d=e-c);var d=isNaN(d)?0:d,e=a.getAttribute("attributeName"),g=a.getAttribute("fill");
b.tagName=="rect"&&(e=="x"&&(e="cx"),e=="y"&&(e="cy"));var j=a.getAttribute("accumulate")=="sum",i=a.getAttribute("additive"),i=i?i=="sum":j,h=a.getAttribute("repeatCount"),h=h=="indefinite"?!0:parseFloat(h);!h&&d>0&&(h=a.getAttribute("repeatDur"),h=h=="indefinite"?!0:f.SVGParser.SVGTagMapping.parseTime(h)/d);return{after:isNaN(c)?0:c,duration:d,restart:a.getAttribute("restart"),calcMode:a.getAttribute("calcMode"),additive:i,accumulate:j,repeat:h,variable:e,fill:g}},parseTime:function(a){if(!a)return null;
if(a.match(/[0-9]$/)){var a=a.split(":"),b=a[a.length-1]||0,c=a[a.length-2]||0;return(parseFloat(a[a.length-3]||0)*3600+parseFloat(c)*60+parseFloat(b))*1E3}else return b=60,a.match(/s$/i)?b=1:a.match(/h$/i)&&(b=3600),parseFloat(a)*b*1E3},animate:function(a,b){var c=this.parseUnit(a.getAttribute("from"),b,"x"),d=this.parseUnit(a.getAttribute("to"),b,"x"),e=this.parseUnit(a.getAttribute("by"),b,"x"),g=f.SVGParser.SVGTagMapping.parseAnimateTag(a,b);if(a.getAttribute("values"))var j=this,i=a.getAttribute("values"),
i=i.split(";").map(function(a){var c=a.split(/[, ]+/);return c.length>2?c.map(function(a){return j.parseUnit(a,b,"x")}):c.length>1?[j.parseUnit(c[0],b,"x"),j.parseUnit(c[1],b,"y")]:j.parseUnit(a,b,"x")});else d==null&&(d=c+e);b.after(g.after,function(){if(g.fill=="remove"){var a=Object.clone(this[g.variable]);this.after(g.duration,function(){this[g.variable]=a})}if(i){if(g.additive){var b=this[g.variable];i=i.map(function(a){return Object.sum(a,b)})}var f=0,j=[];if(i[0]instanceof Array)for(var k=
1;k<i.length;k++){var m=Object.sub(i[k]-i[k-1]),m=Math.sqrt(m.reduce(function(a,b){return a+b*b},0));j.push(m);f+=m}else for(k=1;k<i.length;k++)m=Math.abs(i[k]-i[k-1]),j.push(m),f+=m;this.animate(function(a){if(a==1)this[g.variable]=i[i.length-1];else{if(g.calcMode=="paced"){a*=f;for(var b=0,c,e,d=0;d<j.length;d++){if(b+j[d]>a){c=d;e=(a-b)/j[d];break}b+=j[d]}a=c}else c=a*(i.length-1),a=Math.floor(c),e=c-a;c=a+1;this.tweenVariable(g.variable,i[a],i[c],e,g.calcMode)}},c,d,g.duration,"linear",{repeat:g.repeat,
additive:g.additive,accumulate:g.accumulate})}else c==null&&(c=this[g.variable],e!=null&&(d=c+e)),g.additive&&(c=Object.sum(c,this[g.variable]),d=Object.sum(d,this[g.variable])),this.animate(g.variable,c,d,g.duration,g.calcMode,{repeat:g.repeat,additive:g.additive,accumulate:g.accumulate})})},set:function(a,b){var c=a.getAttribute("to"),d=f.SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(d.after,function(){if(d.fill=="remove"){var a=Object.clone(this[d.variable]);this.after(d.duration,function(){this[d.variable]=
a})}this[d.variable]=c})},animateMotion:function(a,b){var c;if(a.getAttribute("path"))c=new f.Path(a.getAttribute("path"));else if(a.getAttribute("values"))c=a.getAttribute("values"),c=new f.Path("M"+c.split(";").join("L"));else if(a.getAttribute("from")||a.getAttribute("to")||a.getAttribute("by")){c=a.getAttribute("from");var d=a.getAttribute("to"),e=a.getAttribute("by");c||(c="0,0");c=new f.Path("M"+c+(d?"L"+d:"l"+e))}var g=new f.CanvasNode;g.__motionPath=c;var j=a.getAttribute("rotate"),i=f.SVGParser.SVGTagMapping.parseAnimateTag(a,
b);b.after(i.after,function(){if(i.fill=="remove"){var a=this.x,b=this.y;this.after(i.duration,function(){this.x=a;this.y=b})}this.animate(function(a){a=g.__motionPath.pointAngleAt(a,{discrete:i.calcMode=="discrete",linear:i.calcMode=="linear"});this.x=a.point[0];this.y=a.point[1];if(j=="auto")this.rotation=a.angle;else if(j=="auto-reverse")this.rotation=a.angle+Math.PI},0,1,i.duration,"linear",{repeat:i.repeat,additive:i.additive,accumulate:i.accumulate})});return g},mpath:function(a,b,c){a=a.getAttribute("xlink:href");
a=a.replace(/^#/,"");this.getDef(c,a,function(a){b.__motionPath=a})},animateColor:function(a,b,c){var d=a.getAttribute("from"),e=a.getAttribute("to"),d=f.SVGParser.SVGMapping.__parseStyle(d,null,c),e=f.SVGParser.SVGMapping.__parseStyle(e,null,c),g=f.SVGParser.SVGTagMapping.parseAnimateTag(a,b);b.after(g.after,function(){if(g.fill=="remove"){var a=Object.clone(this[g.variable]);this.after(g.duration,function(){this[g.variable]=a})}this.animate(g.variable,d,e,g.duration,"linear",{repeat:g.repeat,additive:g.additive,
accumulate:g.accumulate})})},animateTransform:function(a,b){var c=a.getAttribute("from"),d=a.getAttribute("to"),e=a.getAttribute("by"),g=f.SVGParser.SVGTagMapping.parseAnimateTag(a,b);c&&(c=c.split(/[ ,]+/).map(parseFloat));d&&(d=d.split(/[ ,]+/).map(parseFloat));e&&(e=e.split(/[ ,]+/).map(parseFloat));g.variable=a.getAttribute("type");g.variable=="rotate"?(g.variable="rotation",c&&(c=c.map(function(a){return a*Math.PI/180})),d&&(d=d.map(function(a){return a*Math.PI/180})),e&&(e=e.map(function(a){return a*
Math.PI/180}))):g.variable.match(/^skew/)&&(c&&(c=c.map(function(a){return a*Math.PI/180})),d&&(d=d.map(function(a){return a*Math.PI/180})),e&&(e=e.map(function(a){return a*Math.PI/180})));d==null&&(d=Object.sum(c,e));b.after(g.after,function(){if(g.variable=="translate"){c==null&&(c=[this.x,this.y],e!=null&&(d=Object.sum(c,e)));if(g.fill=="remove"){var a=this.x,b=this.y;this.after(g.duration,function(){this.x=a;this.y=b})}this.animate("x",c[0],d[0],g.duration,"linear",{repeat:g.repeat,additive:g.additive,
accumulate:g.accumulate});c[1]!=null&&this.animate("y",c[1],d[1],g.duration,"linear",{repeat:g.repeat,additive:g.additive,accumulate:g.accumulate})}else{c&&c.length==1&&(c=c[0]);d&&d.length==1&&(d=d[0]);e&&e.length==1&&(e=e[0]);c==null&&(c=this[g.variable],e!=null&&(d=Object.sum(c,e)));if(g.variable=="scale"&&g.additive)g.additive=!1;if(g.fill=="remove"){var f=Object.clone(this[g.variable]);this.after(g.duration,function(){this[g.variable]=f})}this.animate(g.variable,c,d,g.duration,"linear",{repeat:g.repeat,
additive:g.additive,accumulate:g.accumulate})}})},a:function(a){var b=a.getAttribute("xlink:href")||a.getAttribute("href"),a=a.getAttribute("target");return new LinkNode(b,a)},use:function(a,b,c){var a=a.getAttribute("xlink:href")||a.getAttribute("href"),d=new f.CanvasNode;a&&(a=a.replace(/^#/,""),this.getDef(c,a,function(a){a=a.clone();if(d.parent){if(d.stroke)a.stroke=d.stroke;if(d.fill)a.fill=d.fill;d.append(a)}else d=a}));return d},image:function(a,b){var c=a.getAttribute("xlink:href")||a.getAttribute("href");
c&&c.search(/^[a-z]+:/i)!=0&&(c=b.root.filename.split("/").slice(0,-1).join("/")+"/"+c);c=new f.ImageNode(c?Object.loadImage(c):null);c.fill="none";c.dX=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.dY=this.parseUnit(a.getAttribute("y"),b,"y")||0;c.srcWidth=this.parseUnit(a.getAttribute("width"),b,"x");c.srcHeight=this.parseUnit(a.getAttribute("height"),b,"y");return c},path:function(a){return new f.Path(a.getAttribute("d"))},polygon:function(a){return new f.Polygon(a.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat))},
polyline:function(a){return new f.Polygon(a.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat),{closePath:!1})},rect:function(a,b){var c=new f.Rectangle(this.parseUnit(a.getAttribute("width"),b,"x"),this.parseUnit(a.getAttribute("height"),b,"y"));c.cx=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("y"),b,"y")||0;c.rx=this.parseUnit(a.getAttribute("rx"),b,"x")||0;c.ry=this.parseUnit(a.getAttribute("ry"),b,"y")||0;return c},line:function(a,b){var c=
this.parseUnit(a.getAttribute("x1"),b,"x")||0,d=this.parseUnit(a.getAttribute("y1"),b,"y")||0,e=this.parseUnit(a.getAttribute("x2"),b,"x")||0,g=this.parseUnit(a.getAttribute("y2"),b,"y")||0;return new f.Line(c,d,e,g)},circle:function(a,b){var c=new f.Circle(this.parseUnit(a.getAttribute("r"),b)||0);c.cx=this.parseUnit(a.getAttribute("cx"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("cy"),b,"y")||0;return c},ellipse:function(a,b){var c=new f.Ellipse(this.parseUnit(a.getAttribute("rx"),b,"x")||0,this.parseUnit(a.getAttribute("ry"),
b,"y")||0);c.cx=this.parseUnit(a.getAttribute("cx"),b,"x")||0;c.cy=this.parseUnit(a.getAttribute("cy"),b,"y")||0;return c},text:function(a,b){var c;c=E("div",a.textContent.strip());c.style.marginTop="-1em";c.style.whiteSpace="nowrap";c=new f.ElementNode(c);c.xOffset=this.parseUnit(a.getAttribute("x"),b,"x")||0;c.yOffset=this.parseUnit(a.getAttribute("y"),b,"y")||0;return c},style:function(a,b,c,d){this.parseStyle(a,d)},defs:function(){return new f.CanvasNode({visible:!1})},linearGradient:function(a,
b,c,d){var e=new f.Gradient({type:"linear"});e.color=b.color;a.getAttribute("color")&&f.SVGParser.SVGMapping.color(e,a.getAttribute("color"),c,d);e.svgNode=a;var b=a.getAttribute("x1"),g=a.getAttribute("y1"),j=a.getAttribute("x2"),i=a.getAttribute("y2"),h=a.getAttribute("gradientTransform");e.units=a.getAttribute("gradientUnits")||"objectBoundingBox";if(b)e.startX=parseFloat(b)*(b.charAt(b.length-1)=="%"?0.01:1);if(g)e.startY=parseFloat(g)*(g.charAt(g.length-1)=="%"?0.01:1);if(j)e.endX=parseFloat(j)*
(j.charAt(j.length-1)=="%"?0.01:1);if(i)e.endY=parseFloat(i)*(i.charAt(i.length-1)=="%"?0.01:1);h&&this.applySVGTransform(e,h,c,d);this.parseStops(e,a,c,d);return e},radialGradient:function(a,b,c,d){var e=new f.Gradient({type:"radial"});e.color=b.color;a.getAttribute("color")&&f.SVGParser.SVGMapping.color(e,a.getAttribute("color"),c,d);e.svgNode=a;var b=a.getAttribute("r"),g=a.getAttribute("fx"),j=a.getAttribute("fy"),i=a.getAttribute("cx"),h=a.getAttribute("cy"),l=a.getAttribute("gradientTransform");
e.units=a.getAttribute("gradientUnits")||"objectBoundingBox";if(b)e.endRadius=parseFloat(b)*(b.charAt(b.length-1)=="%"?0.01:1);if(g)e.startX=parseFloat(g)*(g.charAt(g.length-1)=="%"?0.01:1);if(j)e.startY=parseFloat(j)*(j.charAt(j.length-1)=="%"?0.01:1);if(i)e.endX=parseFloat(i)*(i.charAt(i.length-1)=="%"?0.01:1);if(h)e.endY=parseFloat(h)*(h.charAt(h.length-1)=="%"?0.01:1);l&&this.applySVGTransform(e,l,c,d);this.parseStops(e,a,c,d);return e}},parseChildren:function(a,b,c,d){for(var e=0;e<a.childNodes.length;e++){var g=
a.childNodes[e],j=!1;if(g.childNodes){if(g.tagName&&(j=this.SVGTagMapping[g.tagName]?this.SVGTagMapping[g.tagName].call(this,g,b,c,d):new f.CanvasNode)){j.root=b.root;j.fontSize=b.fontSize;j.strokeWidth=b.strokeWidth;if(g.attributes)for(var i=0;i<g.attributes.length;i++){var h=g.attributes[i];if(this.SVGMapping[h.nodeName])this.SVGMapping[h.nodeName](j,h.nodeValue,c,d)}j.id&&this.setDef(c,j.id,j);j.tagName=g.tagName;this.applySVGTransform(j,g.getAttribute("transform"),c,d);this.applySVGStyle(j,g.getAttribute("style"),
c,d);j.tagName&&d.tags[j.tagName]&&this.applySVGStyle(j,d.tags[j.tagName],c,d);j.className&&d.classes[j.className]&&this.applySVGStyle(j,d.classes[j.className],c,d);j.id&&d.ids[j.id]&&this.applySVGStyle(j,d.ids[j.id],c,d);if(!j.marker)j.marker=b.marker;if(!j.markerStart)j.markerStart=b.markerStart;if(!j.markerEnd)j.markerEnd=b.markerEnd;if(!j.markerMid)j.markerMid=b.markerMid}if(j&&j.setRoot)j.zIndex=e,b.append(j),this.parseChildren(g,j,c,d)}}},parseStyle:function(a,b){for(var c=a.textContent.split(/\}/m),
d=0;d<c.length;d++){var e=c[d].split(/\{/m);if(!(e.length<2)){var g=e[0].strip(),e=e[1].strip();switch(g.charAt(0)){case ".":b.classes[g.slice(1)]=e;break;case "#":b.ids[g.slice(1)]=e;break;default:b.tags[g]=e}}}},parseStops:function(a,b,c,d){var e=b.getAttribute("xlink:href");a.colorStops=[];e&&(e=e.replace(/^#/,""),this.getDef(c,e,function(b){if(a.colorStops.length==0)a.colorStops=b.colorStops}));for(var e=[],g=0;g<b.childNodes.length;g++){var f=b.childNodes[g];if(f.tagName=="stop"){var i=parseFloat(f.getAttribute("offset"));
f.getAttribute("offset").search(/%/)!=-1&&(i*=0.01);i=[i];i.color=a.color;for(var h=0;h<f.attributes.length;h++){var l=f.attributes[h];if(this.SVGMapping[l.nodeName])this.SVGMapping[l.nodeName](i,l.nodeValue,c,d)}this.applySVGStyle(i,f.getAttribute("style"),c,d);(f=f.getAttribute("id"))&&this.setDef(c,f,i);e.push(i)}}if(e.length>0)a.colorStops=e},applySVGTransform:function(a,b,c,d){if(b){a.transformList=[];for(var b=b.match(/[a-z]+\s*\([^)]*\)/ig),e=0;e<b.length;e++){var g=b[e].split("("),f=g[0].strip();
this.SVGMapping[f]&&(g=g[1].strip().slice(0,-1),this.SVGMapping[f](a,g,c,d))}this.breakDownTransformList(a)}},breakDownTransformList:function(a){var b=a.transformList;if(a.transformList.length==1){b=b[0];if(b[0]=="translate")a.x=b[1][0],a.y=b[1][1];else if(b[0]=="scale")a.scale=b[1];else if(b[0]=="rotate")a.rotation=b[1];else if(b[0]=="matrix")a.matrix=b[1];else if(b[0]=="skewX")a.skewX=b[1][0];else if(b[0]=="skewY")a.skewY=b[1][0];else return;a.transformList=null}},applySVGStyle:function(a,b,c,d){if(b)for(var b=
b.split(";"),e=0;e<b.length;e++){var g=b[e].split(":"),f=g[0].strip();this.SVGMapping[f]&&(g=g[1].strip(),this.SVGMapping[f](a,g,c,d))}},getDef:function(a,b,c){a[b]&&a[b]instanceof Array?a[b].push(c):a[b]?c(a[b]):a[b]=[c]},setDef:function(a,b,c){if(a[b]&&a[b]instanceof Array)for(var d=0;d<a[b].length;d++)a[b][d](c);a[b]=c},parseUnit:function(a,b,c){return a==null?null:this.parseUnitMultiplier(a,b,c)*parseFloat(a.strip())},parseUnitMultiplier:function(a,b,c){var d=this.getCmInPixels();return a.search(/cm$/i)!=
-1?d:a.search(/mm$/i)!=-1?0.1*d:a.search(/pt$/i)!=-1?0.0352777778*d:a.search(/pc$/i)!=-1?0.4233333333*d:a.search(/in$/i)!=-1?2.54*d:a.search(/em$/i)!=-1?b.fontSize:a.search(/ex$/i)!=-1?b.fontSize/2:a.search(/%$/i)!=-1?c=="x"?b.root.innerWidth*0.01:c=="y"?b.root.innerHeight*0.01:b.root.innerSize*0.01:1},getCmInPixels:function(){if(!this.cmInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1cm",height:"1cm",position:"absolute",visibility:"hidden"}});m.body.appendChild(a);var b=a.offsetWidth;
m.body.removeChild(a);this.cmInPixels=b||38}return this.cmInPixels},getEmInPixels:function(){if(!this.emInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1em",height:"1em",position:"absolute",visibility:"hidden"}});m.body.appendChild(a);var b=a.offsetWidth;m.body.removeChild(a);this.emInPixels=b||12}return this.emInPixels},getExInPixels:function(){if(!this.exInPixels){var a=E("div",{style:{margin:"0px",padding:"0px",width:"1ex",height:"1ex",position:"absolute",visibility:"hidden"}});
m.body.appendChild(a);var b=a.offsetWidth;m.body.removeChild(a);this.exInPixels=b||6}return this.exInPixels},SVGMapping:{DEG_TO_RAD_FACTOR:Math.PI/180,RAD_TO_DEG_FACTOR:180/Math.PI,parseUnit:function(a,b,c){return f.SVGParser.parseUnit(a,b,c)},"class":function(a,b){a.className=b},marker:function(a,b,c){f.SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.marker=b})},"marker-start":function(a,b,c){f.SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerStart=b})},"marker-end":function(a,
b,c){f.SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerEnd=b})},"marker-mid":function(a,b,c){f.SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.markerMid=b})},"clip-path":function(a,b,c){f.SVGParser.getDef(c,b.replace(/^url\(#|\)$/g,""),function(b){a.clipPath=b})},id:function(a,b){a.id=b},translate:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);a.transformList.push(["translate",[c[0],c[1]||0]])},rotate:function(a,b){if(!(b=="auto"||b=="auto-reverse")){var c=
b.split(/[\s,]+/).map(parseFloat),d=c[0]*this.DEG_TO_RAD_FACTOR;c.length>1?a.transformList.push(["rotate",[d,c[1],c[2]||0]]):a.transformList.push(["rotate",[d]])}},scale:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat),d=["scale"];d[1]=c.length>1?[c[0],c[1]]:[c[0],c[0]];a.transformList.push(d)},matrix:function(a,b){var c=b.split(/[\s,]+/).map(parseFloat);a.transformList.push(["matrix",c])},skewX:function(a,b){var c=parseFloat(b)*this.DEG_TO_RAD_FACTOR;a.transformList.push(["skewX",[c]])},skewY:function(a,
b){var c=parseFloat(b)*this.DEG_TO_RAD_FACTOR;a.transformList.push(["skewY",[c]])},opacity:function(a,b){a.opacity=parseFloat(b)},display:function(a,b){a.display=b},visibility:function(a,b){a.visibility=b},"stroke-miterlimit":function(a,b){a.miterLimit=parseFloat(b)},"stroke-linecap":function(a,b){a.lineCap=b},"stroke-linejoin":function(a,b){a.lineJoin=b},"stroke-width":function(a,b){a.strokeWidth=this.parseUnit(b,a)},fill:function(a,b,c){a.fill=this.__parseStyle(b,a.fill,c,a.color)},stroke:function(a,
b,c){a.stroke=this.__parseStyle(b,a.stroke,c,a.color)},color:function(a,b,c){if(b!="inherit")a.color=this.__parseStyle(b,!1,c,a.color)},"stop-color":function(a,b,c){a[1]=b=="none"?[0,0,0,0]:this.__parseStyle(b,a[1],c,a.color)},"fill-opacity":function(a,b){a.fillOpacity=Math.min(1,Math.max(0,parseFloat(b)))},"stroke-opacity":function(a,b){a.strokeOpacity=Math.min(1,Math.max(0,parseFloat(b)))},"stop-opacity":function(a,b){a[1]=a[1]||[0,0,0];a[1][3]=Math.min(1,Math.max(0,parseFloat(b)))},"text-anchor":function(a,
b){a.textAnchor=b;a.setAlign&&(b=="middle"?a.setAlign("center"):a.setAlign(b))},"font-family":function(a,b){a.fontFamily=b},"font-size":function(a,b){a.fontSize=this.parseUnit(b,a)},__parseStyle:function(a,b,c,d){if(a.charAt(0)=="#")return a.length==4&&(a=a.replace(/([^#])/g,"$1$1")),c=a.slice(1).match(/../g).map(function(a){return parseInt(a,16)});else if(a.search(/^rgb\(/)!=-1){c=a.slice(4,-1).split(",");for(a=0;a<c.length;a++)b=c[a].strip(),c[a]=b.charAt(b.length-1)=="%"?Math.round(parseFloat(b.slice(0,
-1))*2.55):parseInt(b);return c}else if(a.search(/^rgba\(/)!=-1){c=a.slice(5,-1).split(",");for(a=0;a<3;a++)b=c[a].strip(),c[a]=b.charAt(b.length-1)=="%"?Math.round(parseFloat(b.slice(0,-1))*2.55):parseInt(b);b=c[3].strip();c[3]=b.charAt(b.length-1)=="%"?Math.round(parseFloat(b.slice(0,-1))*0.01):Math.max(0,Math.min(1,parseFloat(b)));return c}else return a.search(/^url\(/)!=-1?(a=a.match(/\([^)]+\)/)[0].slice(1,-1).replace(/^#/,""),c[a]?c[a]:"rgba(255,0,255,1)"):a=="currentColor"?d:a=="none"?"none":
a=="freeze"?null:a=="remove"?null:a}}};T=function(a){return m.createTextNode(a)};f.Timeline=f.Klass({startTime:null,repeat:!1,lastAction:0,initialize:function(a){this.repeat=a;this.keyframes=[]},addKeyframe:function(a,b,c){arguments.length==1?this.keyframes.push(a):this.keyframes.push({time:a,target:b,tween:c})},appendKeyframe:function(a,b,c){this.lastAction+=a;return this.addKeyframe(this.lastAction,b,c)},evaluate:function(a,b){if(this.startTime==null)this.startTime=b;var c=b-this.startTime;if(this.keyframes.length>
0){for(var d,e,g,f=0;f<this.keyframes.length;f++)if(this.keyframes[f].time>c){d=f;break}d!=null&&(e=this.keyframes[d-1],g=this.keyframes[d]);if(g){if(e){this.keyframes.atEnd=!1;var c=(c-e.time)/(g.time-e.time),i;for(i in g.target)e.target[i]!=null&&a.tweenVariable(i,e.target[i],g.target[i],c,g.tween)}}else if(!this.keyframes.atEnd){this.keyframes.atEnd=!0;e=this.keyframes[this.keyframes.length-1];Object.extend(a,Object.clone(e.target));if(this.repeat)this.startTime=b;a.changed=!0}}}});f.Transformable=
f.Klass({needMatrixUpdate:!0,transform:function(a){var b=this.absoluteMatrix,c=this.x||this.y,d=this.rotation,e=this.scale!=null,g=this.skewX,f=this.skewY,i=this.matrix,h=this.transformList;if(this.needMatrixUpdate||!this.currentMatrix){if(!this.currentMatrix)this.currentMatrix=[1,0,0,1,0,0];this.parent?this.__copyMatrix(this.parent.currentMatrix):this.__identityMatrix();b&&this.__setMatrixMatrix(this.absoluteMatrix);c&&this.__translateMatrix(this.x,this.y);d&&this.__rotateMatrix(this.rotation);g&&
this.__skewXMatrix(this.skewX);f&&this.__skewYMatrix(this.skewY);e&&this.__scaleMatrix(this.scale);i&&this.__matrixMatrix(this.matrix);if(h)for(b=0;b<this.transformList.length;b++)h=this.transformList[b],this["__"+h[0]+"Matrix"](h[1]);this.needMatrixUpdate=!1}a&&this.__setMatrix(a,this.currentMatrix)},distanceTo:function(a){return f.Curves.lineLength([this.x,this.y],[a.x,a.y])},angleTo:function(a){return f.Curves.lineAngle([this.x,this.y],[a.x,a.y])},__setMatrixMatrix:function(a){if(!this.previousMatrix)this.previousMatrix=
[];var b=this.previousMatrix,c=this.currentMatrix;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5];b=this.currentMatrix;c=a;b[0]=c[0];b[1]=c[1];b[2]=c[2];b[3]=c[3];b[4]=c[4];b[5]=c[5]},__copyMatrix:function(a){var b=this.currentMatrix;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5]},__identityMatrix:function(){var a=this.currentMatrix;a[0]=1;a[1]=0;a[2]=0;a[3]=1;a[4]=0;a[5]=0},__translateMatrix:function(a,b){a.length?f.CanvasSupport.tTranslate(this.currentMatrix,a[0],a[1]):
f.CanvasSupport.tTranslate(this.currentMatrix,a,b)},__rotateMatrix:function(a){a.length?a[0]%Math.PI*2!=0&&(a[1]||a[2]?(f.CanvasSupport.tTranslate(this.currentMatrix,a[1],a[2]),f.CanvasSupport.tRotate(this.currentMatrix,a[0]),f.CanvasSupport.tTranslate(this.currentMatrix,-a[1],-a[2])):f.CanvasSupport.tRotate(this.currentMatrix,a[0])):a%Math.PI*2!=0&&f.CanvasSupport.tRotate(this.currentMatrix,a)},__skewXMatrix:function(a){a.length&&a[0]?f.CanvasSupport.tSkewX(this.currentMatrix,a[0]):f.CanvasSupport.tSkewX(this.currentMatrix,
a)},__skewYMatrix:function(a){a.length&&a[0]?f.CanvasSupport.tSkewY(this.currentMatrix,a[0]):f.CanvasSupport.tSkewY(this.currentMatrix,a)},__scaleMatrix:function(a){a.length==2?a[0]==1&&a[1]==1||f.CanvasSupport.tScale(this.currentMatrix,a[0],a[1]):a.length==3?a[0]==1||a[0].length&&a[0][0]==1&&a[0][1]==1||(f.CanvasSupport.tTranslate(this.currentMatrix,a[1],a[2]),a[0].length?f.CanvasSupport.tScale(this.currentMatrix,a[0][0],a[0][1]):f.CanvasSupport.tScale(this.currentMatrix,a[0],a[0]),f.CanvasSupport.tTranslate(this.currentMatrix,
-a[1],-a[2])):a!=1&&f.CanvasSupport.tScale(this.currentMatrix,a,a)},__matrixMatrix:function(a){f.CanvasSupport.tMatrixMultiply(this.currentMatrix,a)},__setMatrix:function(a,b){f.CanvasSupport.setTransform(a,b,this.previousMatrix)},__translate:function(a,b,c){b.length!=null?a.translate(b[0],b[1]):a.translate(b,c)},__rotate:function(a,b){b.length?b[1]||b[2]?b[0]%Math.PI*2!=0&&(a.translate(b[1],b[2]),a.rotate(b[0]),a.translate(-b[1],-b[2])):a.rotate(b[0]):a.rotate(b)},__skewX:function(a,b){b.length&&
b[0]?f.CanvasSupport.skewX(a,b[0]):f.CanvasSupport.skewX(a,b)},__skewY:function(a,b){b.length&&b[0]?f.CanvasSupport.skewY(a,b[0]):f.CanvasSupport.skewY(a,b)},__scale:function(a,b){b.length==2?a.scale(b[0],b[1]):b.length==3?(a.translate(b[1],b[2]),b[0].length?a.scale(b[0][0],b[0][1]):a.scale(b[0],b[0]),a.translate(-b[1],-b[2])):a.scale(b,b)},__matrix:function(a,b){f.CanvasSupport.transform(a,b)}});f.CanvasNode=f.Klass(f.Animatable,f.Transformable,{OBJECTBOUNDINGBOX:"objectBoundingBox",visible:!0,drawable:!0,
display:null,visibility:null,catchMouse:!0,pickable:!1,underCursor:!1,zIndex:0,x:0,y:0,scale:1,rotation:0,matrix:null,absoluteMatrix:null,transformList:null,fill:null,stroke:null,strokeWidth:null,lineCap:null,lineJoin:null,miterLimit:null,absoluteOpacity:null,opacity:null,fillOpacity:null,strokeOpacity:null,compositeOperation:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,font:null,textAlign:null,textBaseline:null,cursor:null,changed:!0,tagName:"g",getNextSibling:function(){if(this.parentNode)return this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)+
1];return null},getPreviousSibling:function(){if(this.parentNode)return this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)-1];return null},initialize:function(a){this.root=this;this.currentMatrix=[1,0,0,1,0,0];this.previousMatrix=[1,0,0,1,0,0];this.needMatrixUpdate=!0;this.childNodes=[];this.frameListeners=[];this.eventListeners={};f.Animatable.initialize.call(this);a&&Object.extend(this,a)},clone:function(){var a=Object.clone(this);a.parent=a.root=null;for(var b in this)typeof this[b]==
"object"&&(a[b]=Object.clone(this[b]));a.parent=a.root=null;a.childNodes=[];a.setRoot(null);for(b=0;b<this.childNodes.length;b++){var c=this.childNodes[b].clone();a.append(c)}return a},cloneNode:function(){return this.clone()},getElementById:function(a){if(this.id==a)return this;for(var b=0;b<this.childNodes.length;b++){var c=this.childNodes[b].getElementById(a);if(c)return c}return null},$:function(a){return this.getElementById(a)},appendChild:function(){return this.append.apply(this,arguments)},
append:function(){for(var a=$A(arguments),b=0;b<a.length;b++)a[b].parent&&a[b].removeSelf(),this.childNodes.push(a[b]),a[b].parent=a[b].parentNode=this,a[b].setRoot(this.root);this.changed=!0},removeAllChildren:function(){this.remove.apply(this,this.childNodes)},removeChild:function(){return this.remove.apply(this,arguments)},remove:function(){for(var a=arguments,b=0;b<a.length;b++)this.childNodes.deleteFirst(a[b]),delete a[b].parent,delete a[b].parentNode,a[b].setRoot(null);this.changed=!0},removeSelf:function(){this.parentNode&&
this.parentNode.remove(this)},contains:function(a){for(;a;){if(a==this)return!0;a=a.parentNode}return!1},setRoot:function(a){a||(a=this);this.dispatchEvent({type:"rootChanged",canvasTarget:this,relatedTarget:a});this.root=a;for(var b=0;b<this.childNodes.length;b++)this.childNodes[b].setRoot(a)},addFrameListener:function(a){this.frameListeners.push(a)},removeFrameListener:function(a){this.frameListeners.deleteFirst(a)},addEventListener:function(a,b,c){this.eventListeners[a]||(this.eventListeners[a]=
{capture:[],bubble:[]});this.eventListeners[a][c?"capture":"bubble"].push(b)},when:function(a,b,c){this.addEventListener(a,b,c||!1)},removeEventListener:function(a,b,c){this.eventListeners[a]&&(this.eventListeners[a][c?"capture":"bubble"].deleteFirst(b),this.eventListeners[a].capture.length==0&&this.eventListeners[a].bubble.length==0&&delete this.eventListeners[a])},dispatchEvent:function(a){var b=a.type;if(!a.canvasTarget&&(a.canvasTarget=b.search(/^(key|text)/i)==0?this.root.focused||this.root.target:
this.root.target,!a.canvasTarget))a.canvasTarget=this;for(var b=[],c=a.canvasTarget;c&&c!=this;)b.push(c),c=c.parent;b.push(this);a.canvasPhase="capture";for(c=b.length-1;c>=0;c--)if(!b[c].handleEvent(a))return!1;a.canvasPhase="bubble";for(c=0;c<b.length;c++)if(!b[c].handleEvent(a))return!1;return!0},broadcastEvent:function(a){a.canvasPhase="capture";if(!this.handleEvent(a))return!1;for(var b=0;b<this.childNodes.length;b++)if(!this.childNodes[b].broadcastEvent(a))return!1;a.canvasPhase="bubble";if(!this.handleEvent(a))return!1;
return!0},handleEvent:function(a){var d;var b=a.type,c=a.canvasPhase;if(this.cursor&&c=="capture")a.cursor=this.cursor;if(d=(b=this.eventListeners[b])&&b[c],b=d)for(c=0;c<b.length;c++)if(b[c].call(this,a)==!1||a.stopped)return a.stopped||a.stopPropagation(),a.stopped=!0,!1;return!0},handleUpdate:function(a,b){this.update(a,b);this.willBeDrawn=(!this.parent||this.parent.willBeDrawn)&&(this.display?this.display!="none":this.visible);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].handleUpdate(a,
b);if(this.parent&&this.changed)this.parent.changed=this.changed,this.changed=!1;this.needMatrixUpdate=!0},update:function(){for(var a=this.frameListeners.slice(0),b=0;b<a.length;b++)this.frameListeners.includes(a[b])&&a[b].apply(this,arguments)},handlePick:function(a){if(this.display)this.visible=this.display!="none";if(this.visibility)this.drawable=this.visibility!="hidden";this.underCursor=!1;if(this.visible&&this.catchMouse&&this.root.absoluteMouseX!=null){a.save();this.transform(a,!0);if(this.pickable&&
this.drawable){if(a.isPointInPath&&(a.beginPath(),this.drawPickingPath&&this.drawPickingPath(a)),this.underCursor=f.CanvasSupport.isPointInPath(this.drawPickingPath?a:!1,this.root.mouseX,this.root.mouseY,this.currentMatrix,this))this.root.target=this}else this.underCursor=!1;var b=this.__getChildrenCopy();this.__zSort(b);for(var c=0;c<b.length;c++)if(b[c].handlePick(a),!this.underCursor)this.underCursor=b[c].underCursor;a.restore()}else for(b=this.__getChildrenCopy();b.length>0;)if(a=b.pop(),a.underCursor)a.underCursor=
!1,Array.prototype.push.apply(b,a.childNodes)},__zSort:function(a){a.stableSort(function(a,c){return a.zIndex-c.zIndex})},__getChildrenCopy:function(){if(this.__childNodesCopy){for(;this.__childNodesCopy.length>this.childNodes.length;)this.__childNodesCopy.pop();for(var a=0;a<this.childNodes.length;a++)this.__childNodesCopy[a]=this.childNodes[a]}else this.__childNodesCopy=this.childNodes.slice(0);return this.__childNodesCopy},isPointInPath:!1,handleDraw:function(a){if(this.display)this.visible=this.display!=
"none";if(this.visibility)this.drawable=this.visibility!="hidden";if(this.visible){a.save();var b=a.fontFamily,c=a.fontSize,d=a.fillOn,e=a.strokeOn;if(this.fontFamily)a.fontFamily=this.fontFamily;if(this.fontSize)a.fontSize=this.fontSize;this.transform(a);if(this.clipPath){a.beginPath();if(this.clipPath.units==this.OBJECTBOUNDINGBOX){var g=this.getSubtreeBoundingBox(!0);a.save();a.translate(g[0],g[1]);a.scale(g[2],g[3]);this.clipPath.createSubtreePath(a,!0);a.restore()}else this.clipPath.createSubtreePath(a,
!0);a.clip()}this.drawable&&this.draw&&this.draw(a);g=this.__getChildrenCopy();this.__zSort(g);for(var f=0;f<g.length;f++)g[f].handleDraw(a);a.fontFamily=b;a.fontSize=c;a.fillOn=d;a.strokeOn=e;a.restore()}},transform:function(a,b){f.Transformable.prototype.transform.call(this,a);if(!b){if(this.fill!=null)if(!this.fill||this.fill=="none")a.fillOn=!1;else if(a.fillOn=!0,this.fill!=!0){var c=f.Colors.parseColorStyle(this.fill,a);a.setFillStyle(c)}if(this.stroke!=null)!this.stroke||this.stroke=="none"?
a.strokeOn=!1:(a.strokeOn=!0,this.stroke!=!0&&a.setStrokeStyle(f.Colors.parseColorStyle(this.stroke,a)));this.strokeWidth!=null&&a.setLineWidth(this.strokeWidth);this.lineCap!=null&&a.setLineCap(this.lineCap);this.lineJoin!=null&&a.setLineJoin(this.lineJoin);this.miterLimit!=null&&a.setMiterLimit(this.miterLimit);this.absoluteOpacity!=null&&a.setGlobalAlpha(this.absoluteOpacity);this.opacity!=null&&a.setGlobalAlpha(a.globalAlpha*this.opacity);this.compositeOperation!=null&&a.setGlobalCompositeOperation(this.compositeOperation);
this.shadowColor!=null&&a.setShadowColor(f.Colors.parseColorStyle(this.shadowColor,a));this.shadowBlur!=null&&a.setShadowBlur(this.shadowBlur);this.shadowOffsetX!=null&&a.setShadowOffsetX(this.shadowOffsetX);this.shadowOffsetY!=null&&a.setShadowOffsetY(this.shadowOffsetY);this.textAlign!=null&&a.setTextAlign(this.textAlign);this.textBaseline!=null&&a.setTextBaseline(this.textBaseline);this.font!=null&&a.setFont(this.font)}},drawPickingPath:!1,draw:!1,createSubtreePath:function(a,b){a.save();b||this.transform(a,
!0);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].createSubtreePath(a);a.restore()},getSubtreeBoundingBox:function(a){if(a){var b=this.parent;this.parent=null;this.needMatrixUpdate=!0}for(var c=this.getAxisAlignedBoundingBox(),d=0;d<this.childNodes.length;d++){var e=this.childNodes[d].getSubtreeBoundingBox();c?e&&this.mergeBoundingBoxes(c,e):c=e}if(a)this.parent=b,this.needMatrixUpdate=!0;return c},mergeBoundingBoxes:function(a,b){a[0]>b[0]&&(a[0]=b[0]);a[1]>b[1]&&(a[1]=b[1]);a[2]+a[0]<
b[2]+b[0]&&(a[2]=b[2]+b[0]-a[0]);a[3]+a[1]<b[3]+b[1]&&(a[3]=b[3]+b[1]-a[1])},getAxisAlignedBoundingBox:function(){this.transform(null,!0);if(!this.getBoundingBox)return null;var a=this.getBoundingBox(),b=f.CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0],a[1]),c=f.CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0]+a[2],a[1]+a[3]),d=f.CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0],a[1]+a[3]),a=f.CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,a[0]+a[2],a[1]),e=Math.min(b[0],
c[0],d[0],a[0]),g=Math.min(b[1],c[1],d[1],a[1]);return[e,g,Math.max(b[0],c[0],d[0],a[0])-e,Math.max(b[1],c[1],d[1],a[1])-g]},makeDraggable:function(){this.addEventListener("dragstart",function(a){this.dragStartPosition={x:this.x,y:this.y};a.stopPropagation();a.preventDefault();return!1},!1);this.addEventListener("drag",function(a){this.x=this.dragStartPosition.x+this.root.dragX/this.parent.currentMatrix[0];this.y=this.dragStartPosition.y+this.root.dragY/this.parent.currentMatrix[3];a.stopPropagation();
a.preventDefault();return!1},!1)}});f.ElementNode=f.Klass(f.CanvasNode,{noScaling:!1,noAlpha:!1,inherit:"inherit",align:null,valign:null,xOffset:0,yOffset:0,initialize:function(a,b){f.CanvasNode.initialize.call(this,b);this.content=a;this.element=E("div",a);this.element.style.MozTransformOrigin=this.element.style.webkitTransformOrigin="0 0";this.element.style.position="absolute"},clone:function(){var a=f.CanvasNode.prototype.clone.call(this);if(this.content&&this.content.cloneNode)a.content=this.content.cloneNode(!0);
a.element=E("div",a.content);a.element.style.position="absolute";a.element.style.MozTransformOrigin=a.element.style.webkitTransformOrigin="0 0";return a},setRoot:function(a){f.CanvasNode.setRoot.call(this,a);this.element&&this.element.parentNode&&this.element.parentNode.removeChild&&this.element.parentNode.removeChild(this.element)},handleUpdate:function(a,b){f.CanvasNode.handleUpdate.call(this,a,b);if(!this.willBeDrawn||!this.visible||this.display=="none"||this.visibility=="hidden"||!this.drawable){if(this.element.style.display!=
"none")this.element.style.display="none"}else if(this.element.style.display=="none")this.element.style.display="block"},addEventListener:function(a,b,c){var d=this;return this.element.addEventListener(a,function(){b.apply(d,arguments)},c||!1)},removeEventListener:function(a,b,c){var d=this;return this.element.removeEventListener(a,function(){b.apply(d,arguments)},c||!1)},draw:function(a){if(this.cursor&&this.element.style.cursor!=this.cursor)this.element.style.cursor=this.cursor;if(this.element.style.zIndex!=
this.root.elementNodeZIndexCounter)this.element.style.zIndex=this.root.elementNodeZIndexCounter;this.root.elementNodeZIndexCounter++;var b=this.currentMatrix;xo=this.xOffset;yo=this.yOffset;if(this.fillBoundingBox&&this.parent&&this.parent.getBoundingBox){var c=this.parent.getBoundingBox();xo+=c[0];yo+=c[1]}var d=f.CanvasSupport.tMatrixMultiplyPoint(b.slice(0,4).concat([0,0]),xo,yo),e=this.currentMatrix[4]+d[0],d=this.currentMatrix[5]+d[1],g=this.currentMatrix[2],j=this.currentMatrix[3],i=this.currentMatrix[0],
h=this.currentMatrix[1],g=Math.sqrt(g*g+j*j),i=Math.sqrt(i*i+h*h);if(a.fontFamily!=null)this.element.style.fontFamily=a.fontFamily;h=f.CanvasSupport.isCSSTransformSupported();this.element.style.MozTransform=h&&!this.noScaling?this.element.style.webkitTransform="matrix("+b.join(",")+")":this.element.style.webkitTransform="";this.element.style.fontSize=a.fontSize!=null?this.noScaling||h?a.fontSize+"px":a.fontSize*g+"px":this.noScaling||h?"inherit":100*g+"%";this.element.style.opacity=this.noAlpha?1:
a.globalAlpha;if(!this.element.parentNode&&this.root.canvas.parentNode){this.element.style.visibility="hidden";this.root.canvas.parentNode.appendChild(this.element);var l=!0}b=this.color||this.fill;if(this.parent){if(!b||!b.length)b=this.parent.color;if(!b||!b.length)b=this.parent.fill}if(!b||!b.length)b=a.fillStyle;if(typeof b=="string")this.element.style.color=b.search(/^rgba\(/)!=-1?"rgb("+b.match(/\d+/g).slice(0,3).join(",")+")":b;else if(b.length)this.element.style.color="rgb("+b.slice(0,3).map(Math.floor).join(",")+
")";b=a=0;c?(this.element.style.width=Math.floor(i*c[2])+"px",this.element.style.height=Math.floor(g*c[3])+"px",this.eWidth=i,this.eHeight=g):(this.element.style.width="",this.element.style.height="",j=this.align||this.textAnchor,c=[0,0],j=="center"||j=="middle"?(a=-this.element.offsetWidth/2,c[0]="50%"):j=="right"&&(a=-this.element.offsetWidth,c[0]="100%"),j=this.valign,j=="center"||j=="middle"?(b=-this.element.offsetHeight/2,c[1]="50%"):j=="bottom"&&(b=-this.element.offsetHeight,c[1]="100%"),this.element.style.webkitTransformOrigin=
this.element.style.MozTransformOrigin=c.join(" "),this.eWidth=this.element.offsetWidth/i,this.eHeight=this.element.offsetHeight/g);h&&!this.noScaling?(this.element.style.left=Math.floor(a)+"px",this.element.style.top=Math.floor(b)+"px"):(this.element.style.left=Math.floor(e+a)+"px",this.element.style.top=Math.floor(d+b)+"px");if(l)this.element.style.visibility="visible"}});f.Canvas=f.Klass(f.CanvasNode,{clear:!0,frameLoop:!1,recording:!1,opacity:1,frame:0,elapsed:0,frameDuration:30,speed:1,time:0,
fps:0,currentRealFps:0,currentFps:0,fpsFrames:30,startTime:0,realFps:0,fixedTimestep:!1,playOnlyWhenFocused:!0,isPlaying:!0,redrawOnlyWhenChanged:!1,changed:!0,drawBoundingBoxes:!1,cursor:"default",mouseDown:!1,mouseEvents:[],absoluteMouseX:null,absoluteMouseY:null,mouseX:null,mouseY:null,elementNodeZIndexCounter:0,initialize:function(a,b){if(arguments.length>2){var c=arguments[0],d=arguments[1],e=arguments[2],b=arguments[3],a=E.canvas(d,e);this.canvasContainer=d=E("div",a,{style:{overflow:"hidden",
width:d+"px",height:e+"px",position:"relative"}});c&&c.appendChild(d)}f.CanvasNode.initialize.call(this,b);this.mouseEventStack=[];this.canvas=a;a.canvas=this;this.width=this.canvas.width;this.height=this.canvas.height;var g=this;this.frameHandler=function(){g.onFrame()};this.canvas.addEventListener("DOMNodeInserted",function(a){a.target==this&&g.addEventListeners()},!1);this.canvas.addEventListener("DOMNodeRemoved",function(a){a.target==this&&g.removeEventListeners()},!1);this.canvas.parentNode&&
this.addEventListeners();this.startTime=(new Date).getTime();this.isPlaying&&this.play()},removeEventListeners:function(){},addEventListeners:function(){var a=this;this.canvas.parentNode.addMouseEvent=function(b){b=f.Mouse.getRelativeCoords(this,b);a.absoluteMouseX=b.x;a.absoluteMouseY=b.y;var c=m.defaultView.getComputedStyle(a.canvas,""),b=parseFloat(c.getPropertyValue("width")),c=parseFloat(c.getPropertyValue("height"));a.mouseX=a.absoluteMouseX*(b/a.canvas.width);a.mouseY=a.absoluteMouseY*(c/a.canvas.height);
a.addMouseEvent(a.mouseX,a.mouseY,a.mouseDown)};this.canvas.parentNode.contains=this.contains;this.canvas.parentNode.addEventListener("mousedown",function(b){a.mouseDown=!0;if(a.keyTarget!=a.target)a.keyTarget&&a.dispatchEvent({type:"blur",canvasTarget:a.keyTarget}),a.keyTarget=a.target,a.keyTarget&&a.dispatchEvent({type:"focus",canvasTarget:a.keyTarget});this.addMouseEvent(b)},!0);this.canvas.parentNode.addEventListener("mouseup",function(b){this.addMouseEvent(b);a.mouseDown=!1},!0);this.canvas.parentNode.addEventListener("mousemove",
function(b){this.addMouseEvent(b);if(a.prevClientX==null)a.prevClientX=b.clientX,a.prevClientY=b.clientY;if(a.dragTarget){var c=m.createEvent("MouseEvents");c.initMouseEvent("drag",!0,!0,k,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;c.dx=b.clientX-a.prevClientX;c.dy=b.clientY-a.prevClientY;a.dragX+=c.dx;a.dragY+=c.dy;a.dispatchEvent(c)}if(a.mouseDown){if(!a.dragTarget&&a.target)a.dragTarget=a.target,
c=m.createEvent("MouseEvents"),c.initMouseEvent("dragstart",!0,!0,k,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget),c.canvasTarget=a.dragTarget,a.dragStartX=b.clientX,a.dragStartY=b.clientY,a.dragX=a.dragY=0,a.dispatchEvent(c)}else if(a.dragTarget)c=m.createEvent("MouseEvents"),c.initMouseEvent("dragend",!0,!0,k,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget),c.canvasTarget=
a.dragTarget,a.dispatchEvent(c),a.dragX=a.dragY=0,a.dragTarget=!1;a.prevClientX=b.clientX;a.prevClientY=b.clientY},!0);this.canvas.parentNode.addEventListener("mouseout",function(b){if(!f.CanvasNode.contains.call(this,b.relatedTarget))a.absoluteMouseX=a.absoluteMouseY=a.mouseX=a.mouseY=null},!0);for(var b=this.dispatchEvent.bind(this),c=["mousemove","mouseover","mouseout","click","dblclick","mousedown","mouseup","keypress","keydown","keyup","DOMMouseScroll","mousewheel","mousemultiwheel","textInput",
"focus","blur"],d=0;d<c.length;d++)this.canvas.parentNode.addEventListener(c[d],b,!1);this.keys={};this.windowEventListeners={keydown:function(b){if(a.keyTarget)a.updateKeys(b),b.canvasTarget=a.keyTarget,a.dispatchEvent(b)},keyup:function(b){if(a.keyTarget)a.updateKeys(b),b.canvasTarget=a.keyTarget,a.dispatchEvent(b)},keypress:function(b){if(a.keyTarget)b.canvasTarget=a.keyTarget,a.dispatchEvent(b)},blur:function(){a.absoluteMouseX=a.absoluteMouseY=null;if(a.playOnlyWhenFocused&&a.isPlaying)a.stop(),
a.__blurStop=!0},focus:function(){a.__blurStop&&!a.isPlaying&&a.play()},mouseup:function(b){a.mouseDown=!1;if(a.dragTarget){var c=m.createEvent("MouseEvents");c.initMouseEvent("dragend",!0,!0,k,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);c.canvasTarget=a.dragTarget;a.dispatchEvent(c);a.dragTarget=!1}if(!a.canvas.parentNode.contains(b.target)){b=a.dispatchEvent(b);if(a.keyTarget)a.dispatchEvent({type:"blur",canvasTarget:a.keyTarget}),
a.keyTarget=null;return b}},mousemove:function(b){a.__blurStop&&!a.isPlaying&&a.play();if(!a.canvas.parentNode.contains(b.target)&&a.mouseDown)return a.dispatchEvent(b)}};this.canvas.parentNode.addEventListener("DOMNodeRemoved",function(b){b.target==this&&a.removeWindowEventListeners()},!1);this.canvas.parentNode.addEventListener("DOMNodeInserted",function(b){b.target==this&&a.addWindowEventListeners()},!1);this.canvas.parentNode.parentNode&&this.addWindowEventListeners()},updateKeys:function(a){this.keys.shift=
a.shiftKey;this.keys.ctrl=a.ctrlKey;this.keys.alt=a.altKey;this.keys.meta=a.metaKey;var b=a.type=="keydown";switch(a.keyCode){case 37:this.keys.left=b;break;case 38:this.keys.up=b;break;case 39:this.keys.right=b;break;case 40:this.keys.down=b;break;case 32:this.keys.space=b;break;case 13:this.keys.enter=b;break;case 9:this.keys.tab=b;break;case 8:this.keys.backspace=b;break;case 16:this.keys.shift=b;break;case 17:this.keys.ctrl=b;break;case 18:this.keys.alt=b}this.keys[a.keyCode]=b},addWindowEventListeners:function(){for(var a in this.windowEventListeners)k.addEventListener(a,
this.windowEventListeners[a],!1)},removeWindowEventListeners:function(){for(var a in this.windowEventListeners)k.removeEventListener(a,this.windowEventListeners[a],!1)},addMouseEvent:function(a,b,c){var d=this.allocMouseEvent();d[0]=a;d[1]=b;d[2]=c;this.mouseEvents.push(d)},allocMouseEvent:function(){return this.mouseEventStack.length>0?this.mouseEventStack.pop():[null,null,null]},freeMouseEvent:function(a){this.mouseEventStack.push(a);this.mouseEventStack.length>100&&this.mouseEventStack.splice(0,
this.mouseEventStack.length)},clearMouseEvents:function(){for(;this.mouseEvents.length>0;)this.freeMouseEvent(this.mouseEvents.pop())},createFrameLoop:function(){var a=this,b={running:!0,stop:function(){this.running=!1},run:function(){b.running&&(a.onFrame(),requestAnimFrame(b.run,a.canvas))}};requestAnimFrame(b.run,this.canvas);return b},play:function(){this.stop();this.realTime=(new Date).getTime();this.frameLoop=this.createFrameLoop();this.isPlaying=!0},stop:function(){this.__blurStop=!1;if(this.frameLoop)this.frameLoop.stop(),
this.frameLoop=null;this.isPlaying=!1},dispatchEvent:function(a){var b=f.CanvasNode.prototype.dispatchEvent.call(this,a);if(a.cursor){if(this.canvas.style.cursor!=a.cursor)this.canvas.style.cursor=a.cursor}else if(this.canvas.style.cursor!=this.cursor)this.canvas.style.cursor=this.cursor;return b},onFrame:function(a,b){this.elementNodeZIndexCounter=0;var c=this.getContext();try{var d=(new Date).getTime();this.currentRealElapsed=d-this.realTime;this.currentRealFps=1E3/this.currentRealElapsed;var e=
this.frameDuration*this.speed;this.fixedTimestep||(e=this.currentRealElapsed*this.speed);this.realTime=d;a!=null?(this.time=a,b&&(e=b)):this.time+=e;this.previousTarget=this.target;this.target=null;this.catchMouse&&this.handlePick(c);if(this.previousTarget!=this.target){if(this.previousTarget){var g=m.createEvent("MouseEvents");g.initMouseEvent("mouseout",!0,!0,k,0,0,0,0,0,!1,!1,!1,!1,0,null);g.canvasTarget=this.previousTarget;this.dispatchEvent(g)}if(this.target)g=m.createEvent("MouseEvents"),g.initMouseEvent("mouseover",
!0,!0,k,0,0,0,0,0,!1,!1,!1,!1,0,null),g.canvasTarget=this.target,this.dispatchEvent(g)}this.handleUpdate(this.time,e);this.clearMouseEvents();if(!this.redrawOnlyWhenChanged||this.changed){try{this.handleDraw(c)}catch(f){throw console.log(f),f;}this.changed=!1}this.currentElapsed=(new Date).getTime()-this.realTime;this.elapsed+=this.currentElapsed;this.currentFps=1E3/this.currentElapsed;this.frame++;if(this.frame%this.fpsFrames==0)this.fps=this.fpsFrames*1E3/this.elapsed,this.realFps=this.fpsFrames*
1E3/((new Date).getTime()-this.startTime),this.elapsed=0,this.startTime=(new Date).getTime()}catch(i){if(c)try{for(d=0;d<1E3;d++)c.restore()}catch(h){}delete this.context;throw i;}},getContext:function(){return this.recording?this.getRecordingContext():this.useMockContext?this.getMockContext():this.get2DContext()},get2DContext:function(){if(!this.context)this.context=f.CanvasSupport.getContext(this.canvas,"2d");return this.context},getMockContext:function(){if(!this.fakeContext){var a=this.get2DContext();
this.fakeContext={};var b=function(){return this},c;for(c in a)this.fakeContext[c]=typeof a[c]=="function"?b:a[c];this.fakeContext.isMockObject=!0;this.fakeContext.addColorStop=b}return this.fakeContext},getRecordingContext:function(){if(!this.recordingContext)this.recordingContext=new f.RecordingContext;return this.recordingContext},drawPickingPath:function(a){a.rect(0,0,this.canvas.width,this.canvas.height)},isPointInPath:function(a,b){return a>=0&&a<=this.canvas.width&&b>=0&&b<=this.canvas.height},
draw:function(a){a.setGlobalAlpha(this.opacity);this.clear&&(a.fillOn?(a.beginPath(),a.rect(0,0,this.canvas.width,this.canvas.height),a.fill()):a.clearRect(0,0,this.canvas.width,this.canvas.height));a.fillStyle="black";a.strokeStyle="black";a.fillOn=!1;a.strokeOn=!1}});LinkNode=f.Klass(f.CanvasNode,{href:null,target:"_self",cursor:"pointer",initialize:function(a,b,c){this.href=a;if(b)this.target=b;f.CanvasNode.initialize.call(this,c);this.setupLinkEventListeners()},setupLinkEventListeners:function(){this.addEventListener("click",
function(a){if(a.button!=f.Mouse.RIGHT){var b=this.target;if((a.ctrlKey||a.button==f.Mouse.MIDDLE)&&b=="_self")b="_blank";k.open(this.href,b)}},!1)}});AudioNode=f.Klass(f.CanvasNode,{ready:!1,autoPlay:!1,playing:!1,paused:!1,pan:0,volume:1,loop:!1,transformSound:!1,initialize:function(a,b){f.CanvasNode.initialize.call(this,b);this.filename=a;this.when("load",this._autoPlaySound);this.loadSound()},loadSound:function(){if(this.sound=f.CanvasSupport.getSoundObject()){var a=this;this.sound.onready=function(){a.ready=
!0;a.root.dispatchEvent({type:"ready",canvasTarget:a})};this.sound.onload=function(){a.loaded=!0;a.root.dispatchEvent({type:"load",canvasTarget:a})};this.sound.onerror=function(){a.root.dispatchEvent({type:"error",canvasTarget:a})};this.sound.onfinish=function(){a.loop?a.play():a.stop()};this.sound.load(this.filename)}},play:function(){this.needPlayUpdate=this.playing=!0},stop:function(){this.playing=!1;this.needPlayUpdate=!0},pause:function(){this.needPauseUpdate?this.needPauseUpdate=!1:(this.paused=
!this.paused,this.needPauseUpdate=!0)},setVolume:function(a){this.volume=a;this.needStatusUpdate=!0},setPan:function(a){this.pan=a;this.needStatusUpdate=!0},handleUpdate:function(){f.CanvasNode.handleUpdate.apply(this,arguments);if(this.willBeDrawn&&(this.transform(null,!0),this.sound||this.loadSound(),this.ready)){if(this.transformSound){var a=this.currentMatrix[4],b=this.currentMatrix[2],c=this.currentMatrix[3],d=this.root.width*0.5;this.setVolume(Math.sqrt(b*b+c*c));this.setPan((a-d)/d)}if(this.needPauseUpdate)this.needPauseUpdate=
!1,this._pauseSound();if(this.needPlayUpdate)this.needPlayUpdate=!1,this.playing?this._playSound():this._stopSound();this.needStatusUpdate&&(this._setSoundVolume(),this._setSoundPan())}},_autoPlaySound:function(){this.autoPlay&&this.play()},_setSoundVolume:function(){this.sound.setVolume(this.volume)},_setSoundPan:function(){this.sound.setPan(this.pan)},_playSound:function(){if(this.sound.play()==!1)return this.playing=!1;this.root.dispatchEvent({type:"play",canvasTarget:this})},_stopSound:function(){this.sound.stop();
this.root.dispatchEvent({type:"stop",canvasTarget:this})},_pauseSound:function(){this.sound.pause();this.root.dispatchEvent({type:this.paused?"pause":"play",canvasTarget:this})}});f.Drawable=f.Klass(f.CanvasNode,{pickable:!0,strokeMode:"above",ABOVE:"above",BELOW:"below",INSIDE:"inside",initialize:function(a){f.CanvasNode.initialize.call(this,a)},drawPickingPath:function(a){this.drawGeometry&&(a.beginPath(),this.drawGeometry(a))},isPointInPath:function(){return!1},isVisible:function(a){var b=this.getAxisAlignedBoundingBox();
if(!b)return!0;var c=b[0],d=b[0]+b[2],e=b[1],b=b[1]+b[3],g=this.root.width,j=this.root.height;if(this.root.drawBoundingBoxes){a.save();var i=this.getBoundingBox();a.beginPath();a.rect(i[0],i[1],i[2],i[3]);a.strokeStyle="green";a.lineWidth=1;a.stroke();a.restore();a.save();f.CanvasSupport.setTransform(a,[1,0,0,1,0,0],this.currentMatrix);a.beginPath();a.rect(c,e,d-c,b-e);a.strokeStyle="red";a.lineWidth=1.5;a.stroke();a.restore()}return!(d<0||c>g||b<0||e>j)},createSubtreePath:function(a,b){a.save();
b||this.transform(a,!0);this.drawGeometry&&this.drawGeometry(a);for(var c=0;c<this.childNodes.length;c++)this.childNodes[c].createSubtreePath(a);a.restore()},draw:function(a){if(this.drawGeometry){this.root.drawBoundingBoxes&&this.isVisible(a);var b=a.fillStyle.transformList||a.fillStyle.matrix||a.fillStyle.scale!=null||a.fillStyle.rotation||a.fillStyle.x||a.fillStyle.y,c=a.strokeStyle.transformList||a.strokeStyle.matrix||a.strokeStyle.scale!=null||a.strokeStyle.rotation||a.strokeStyle.x||a.strokeStyle.y;
a.beginPath();this.drawGeometry(a);if(a.strokeOn)switch(this.strokeMode){case this.ABOVE:a.fillOn&&this.doFill(a,b);this.doStroke(a,c);break;case this.BELOW:this.doStroke(a,c);a.fillOn&&this.doFill(a,b);break;case this.INSIDE:a.fillOn&&this.doFill(a,b),a.save(),b=a.lineWidth,a.setLineWidth(1),this.doStroke(a,c),a.setLineWidth(b),a.clip(),this.doStroke(a,c),a.restore()}else a.fillOn&&this.doFill(a,b);this.drawMarkers(a);this.clip&&a.clip()}},doFill:function(a,b){if(b||this.getBoundingBox&&a.fillStyle.units==
this.OBJECTBOUNDINGBOX){a.save();if(this.getBoundingBox&&a.fillStyle.units==this.OBJECTBOUNDINGBOX){var c=this.getBoundingBox(),d=c[2],e=c[3];a.translate(c[0],c[1]);a.scale(d,e)}a.fillStyle.transform(a)}this.fillOpacity!=null?(c=a.globalAlpha,a.setGlobalAlpha(c*this.fillOpacity),a.fill(),a.globalAlpha=c):a.fill();b&&a.restore()},doStroke:function(a,b){if(b||this.getBoundingBox&&a.strokeStyle.units==this.OBJECTBOUNDINGBOX){a.save();if(this.getBoundingBox&&a.strokeStyle.units==this.OBJECTBOUNDINGBOX){var c=
this.getBoundingBox(),d=c[2],e=c[3];a.translate(c[0],c[1]);a.scale(d,e)}a.strokeStyle.needMatrixUpdate=!0;a.strokeStyle.transform(a);d!=null&&f.CanvasSupport.tScale(a.strokeStyle.currentMatrix,d,e);c=a.strokeStyle.currentMatrix;a.setLineWidth((a.lineWidth==null?1:a.lineWidth)/Math.sqrt(Math.max(c[0]*c[0]+c[1]*c[1],c[2]*c[2]+c[3]*c[3])))}this.strokeOpacity!=null?(c=a.globalAlpha,a.setGlobalAlpha(c*this.strokeOpacity),a.stroke(),a.globalAlpha=c):a.stroke();b&&a.restore()},drawMarkers:function(a){var b=
this.markerStart||this.marker,c=this.markerEnd||this.marker,d=this.markerMid||this.marker;if(b&&this.getStartPoint){var e=this.getStartPoint();if(b.orient!=null&&b.orient!="auto")e.angle=b.orient;var g=b.markerUnits=="strokeWidth"?a.lineWidth:1;a.save();a.translate(e.point[0],e.point[1]);a.scale(g,g);a.rotate(e.angle);e=f.CanvasSupport.tRotate(f.CanvasSupport.tScale(f.CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),g,g),e.angle);b.__copyMatrix(e);b.handleDraw(a);a.restore()}if(c&&
this.getEndPoint){e=this.getEndPoint();if(c.orient!=null&&c.orient!="auto")e.angle=c.orient;g=c.markerUnits=="strokeWidth"?a.lineWidth:1;a.save();a.translate(e.point[0],e.point[1]);a.scale(g,g);a.rotate(e.angle);e=f.CanvasSupport.tRotate(f.CanvasSupport.tScale(f.CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),g,g),e.angle);c.__copyMatrix(e);c.handleDraw(a);a.restore()}if(d&&this.getMidPoints)for(var b=this.getMidPoints(),g=d.markerUnits=="strokeWidth"?a.lineWidth:1,j=0;j<
b.length;j++){e=b[j];a.save();a.translate(e.point[0],e.point[1]);a.scale(g,g);if(d.orient!=null&&d.orient!="auto")e.angle=c.orient;a.rotate(e.angle);e=f.CanvasSupport.tRotate(f.CanvasSupport.tScale(f.CanvasSupport.tTranslate(this.currentMatrix.slice(0),e.point[0],e.point[1]),g,g),e.angle);d.__copyMatrix(e);d.handleDraw(a);a.restore()}},getStartPoint:!1,getEndPoint:!1,getMidPoints:!1,getBoundingBox:!1});f.CatmullRomSpline=f.Klass(f.Drawable,{segments:[],loop:!1,closePath:!1,initialize:function(a,b){this.segments=
a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.currentMatrix[0],c=this.currentMatrix[1],d=this.currentMatrix[2],e=this.currentMatrix[3],c=Math.floor(Math.sqrt(Math.max(b*b+c*c,d*d+e*e))),b=this.compiled;if(!b||b.scale!=c)b=this.compile(c);for(c=0;c<b.length;c++)d=b[c],a[d[0]].apply(a,d[1]);this.closePath&&a.closePath()},compile:function(a){a||(a=1);var b=[];if(this.segments&&this.segments.length>=(this.loop?1:4)){var c=this.segments;this.loop&&(c=c.slice(0),c.unshift(c[c.length-
1]),c.push(c[1]),c.push(c[2]));var d=1/(15*(a+0.5)),e,g,j,i,h;b.push(["moveTo",c[1].slice(0)]);for(var l=1;l<c.length-2;l++){e=c[l-1];g=c[l];j=c[l+1];i=c[l+2];for(var k=0;k<1;k+=d)h=f.Curves.catmullRomPoint(e,g,j,i,k),b.push(["lineTo",h])}h=f.Curves.catmullRomPoint(e,g,j,i,1);b.push(["lineTo",h])}b.scale=a;return this.compiled=b},getBoundingBox:function(){for(var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity,e=this.compiled?this.compiled:this.compile(),g=0;g<e.length;g++)for(var f=e[g][1],i=0;i<f.length;i+=
2){var h=f[i],l=f[i+1];h<a&&(a=h);h>c&&(c=h);l<b&&(b=l);l>d&&(d=l)}return[a,b,c-a,d-b]},pointAt:function(a){if(!this.segments)return[0,0];if(this.segments.length>=(this.loop?1:4)){var b=this.segments;this.loop&&(b=b.slice(0),b.unshift(b[b.length-1]),b.push(b[1]),b.push(b[2]));a*=b.length-3;var c=Math.floor(a);return f.Curves.catmullRomPoint(b[c],b[c+1],b[c+2],b[c+3],a-c)}else return this.segments[0]},pointAngleAt:function(a){if(!this.segments)return{point:[0,0],angle:0};if(this.segments.length>=(this.loop?
1:4)){var b=this.segments;this.loop&&(b=b.slice(0),b.unshift(b[b.length-1]),b.push(b[1]),b.push(b[2]));a*=b.length-3;var c=Math.floor(a);return f.Curves.catmullRomPointAngle(b[c],b[c+1],b[c+2],b[c+3],a-c)}else return{point:this.segments[0]||[0,0],angle:0}}});f.Circle=f.Klass(f.Drawable,{cx:0,cy:0,radius:10,startAngle:0,endAngle:Math.PI*2,clockwise:!1,closePath:!0,includeCenter:!1,initialize:function(a,b){if(a!=null)this.radius=a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){this.radius!=
0&&(this.includeCenter&&a.moveTo(this.cx,this.cy),a.arc(this.cx,this.cy,this.radius,this.startAngle,this.endAngle,this.clockwise),this.closePath&&(a.moveTo(this.cx+Math.cos(this.endAngle)*this.radius,this.cy+Math.sin(this.endAngle)*this.radius),a.closePath()))},isPointInPath:function(a,b){a-=this.cx;b-=this.cy;return a*a+b*b<=this.radius*this.radius},getBoundingBox:function(){return[this.cx-this.radius,this.cy-this.radius,2*this.radius,2*this.radius]}});f.Ellipse=f.Klass(f.Circle,{radiusX:0,radiusY:0,
initialize:function(a,b,c){this.radiusX=a;this.radiusY=b;f.Circle.initialize.call(this,1,c)},drawGeometry:function(a){if(!(this.radiusX==0||this.radiusY==0)){var b=this.cx,c=this.cy,d=0.5522847498*this.radiusX,e=0.5522847498*this.radiusY;a.moveTo(b+this.radiusX,c);a.bezierCurveTo(b+this.radiusX,c-e,b+d,c-this.radiusY,b,c-this.radiusY);a.bezierCurveTo(b-d,c-this.radiusY,b-this.radiusX,c-e,b-this.radiusX,c);a.bezierCurveTo(b-this.radiusX,c+e,b-d,c+this.radiusY,b,c+this.radiusY);a.bezierCurveTo(b+d,
c+this.radiusY,b+this.radiusX,c+e,b+this.radiusX,c)}},isPointInPath:function(a,b){a-=this.cx;b-=this.cy;a/=this.radiusX;b/=this.radiusY;return a*a+b*b<=1},getBoundingBox:function(){return[this.cx-this.radiusX,this.cy-this.radiusY,this.radiusX*2,this.radiusY*2]}});f.ImageNode=f.Klass(f.Drawable,{centered:!1,usePattern:!1,sX:0,sY:0,sWidth:null,sHeight:null,dX:0,dY:0,dWidth:null,dHeight:null,initialize:function(a,b){this.image=a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){if(Object.isImageLoaded(this.image)){var b=
this.dWidth==null?this.image.width:this.dWidth,c=this.dHeight==null?this.image.height:this.dHeight,d=this.dX+(this.centered?-b*0.5:0),e=this.dY+(this.centered?-c*0.5:0);if(this.dWidth!=null)this.sWidth!=null?a.drawImage(this.image,this.sX,this.sY,this.sWidth,this.sHeight,d,e,b,c):a.drawImage(this.image,d,e,b,c);else if(b=this.image.width,c=this.image.height,this.usePattern){if(!this.imagePattern)this.imagePattern=new f.Pattern(this.image,"repeat");var g=this.imagePattern.compiled;g||(g=this.imagePattern.compile(a));
a.save();a.beginPath();a.rect(d,e,b,c);a.setFillStyle(g);a.fill();a.restore();a.beginPath()}else a.drawImage(this.image,d,e)}else{b=this.dWidth;c=this.dHeight;if(!b||!c)return;d=this.dX+(this.centered?-b*0.5:0);e=this.dY+(this.centered?-c*0.5:0)}a.rect(d,e,b,c)},drawPickingPath:function(a){var b=this.dX+(this.centered?-this.image.width*0.5:0),c=this.dY+(this.centered?-this.image.height*0.5:0),d=this.dWidth,e=this.dHeight;if(this.dWidth==null)d=this.image.width,e=this.image.height;a.rect(b,c,d,e)},
isPointInPath:function(a,b){a-=this.dX;b-=this.dY;this.centered&&(a+=this.image.width*0.5,b+=this.image.height*0.5);var c=this.dWidth,d=this.dHeight;if(this.dWidth==null)c=this.image.width,d=this.image.height;return a>=0&&a<=c&&b>=0&&b<=d},getBoundingBox:function(){x=this.dX;y=this.dY;this.centered&&(x-=this.image.width*0.5,y-=this.image.height*0.5);var a=this.dWidth,b=this.dHeight;if(this.dWidth==null)a=this.image.width,b=this.image.height;return[x,y,a,b]}});f.ImageNode.load=function(a){var b=new Image;
b.src=a;return new f.ImageNode(b)};f.Line=f.Klass(f.Drawable,{x1:0,y1:0,x2:0,y2:0,stroke:!0,initialize:function(a,b,c,d,e){this.x1=a;this.y1=b;this.x2=c;this.y2=d;f.Drawable.initialize.call(this,e)},drawGeometry:function(a){a.moveTo(this.x1,this.y1);a.lineTo(this.x2,this.y2)},getStartPoint:function(){return{point:[this.x1,this.y1],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getEndPoint:function(){return{point:[this.x2,this.y2],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getBoundingBox:function(){return[this.x1,
this.y1,this.x2-this.x1,this.y2-this.y1]},getLength:function(){return f.Curves.lineLength([this.x1,this.y1],[this.x2,this.y2])}});f.Path=f.Klass(f.Drawable,{segments:[],closePath:!1,initialize:function(a,b){this.segments=a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){for(var b=this.getSegments(),c=0;c<b.length;c++){var d=b[c];a[d[0]].apply(a,d[1])}this.closePath&&a.closePath()},isPointInPath:function(a,b){var c=this.getBoundingBox();return a>=c[0]&&a<=c[0]+c[2]&&b>=c[1]&&b<=c[1]+c[3]},
getBoundingBox:function(){if(!this.compiled||!this.compiledBoundingBox){for(var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity,e=this.getSegments(),g=0;g<e.length;g++)for(var f=e[g][1],i=0;i<f.length;i+=2){var h=f[i],l=f[i+1];h<a&&(a=h);h>c&&(c=h);l<b&&(b=l);l>d&&(d=l)}this.compiledBoundingBox=[a,b,c-a,d-b]}return this.compiledBoundingBox},getStartPoint:function(){var a=this.getSegments();if(!a||!a[0])return{point:[0,0],angle:0};var b=a[0][1],b=[b[b.length-2],b[b.length-1]],a=a[1],c=0;a&&(c2=a[1],
c=f.Curves.lineAngle(b,[c2[c2.length-2],c2[c2.length-1]]));return{point:b,angle:c}},getEndPoint:function(){var a=this.getSegments();if(!a||!a[0])return{point:[0,0],angle:0};var b=a[a.length-1][1],b=[b[b.length-2],b[b.length-1]],a=a[a.length-2],c=0;a&&(c2=a[1],c=f.Curves.lineAngle([c2[c2.length-2],c2[c2.length-1]],b));return{point:b,angle:c}},getMidPoints:function(){var a=this.getSegments();if(this.vertices)return this.vertices.slice(1,-1);for(var b=[],c=1;c<a.length-1;c++){var d=a[c-1][1].slice(-2),
e=a[c][1].slice(0,2);if(a[c-1].length>2)var g=a[c-1][1].slice(-4,-2),e=0.5*(Curves.lineAngle(g,d)+f.Curves.lineAngle(d,e));else e=f.Curves.lineAngle(d,e);b.push({point:d,angle:e});d=a[c][2];if(d!=null){for(c++;a[c]&&a[c][2]==d;)c++;c--}}return b},getSegments:function(){if(typeof this.segments=="string"){if(!this.compiled||this.segments!=this.compiledSegments)this.compiled=this.compileSVGPath(this.segments),this.compiledSegments=this.segments}else if(!this.compiled)this.compiled=Object.clone(this.segments);
return this.compiled},compileSVGPath:function(a){for(var a=a.split(/(?=[a-z])/i),b=0,c=0,d,e,g,f=[],i=0;i<a.length;i++){var h=a[i],l=h.match(/[a-z]/i);if(!l)return[];l=l[0];(h=h.match(/[+-]?\d+(\.\d+(e\d+(\.\d+)?)?)?/gi))&&(h=h.map(parseFloat));switch(l){case "M":b=h[0];c=h[1];d=e=null;f.push(["moveTo",[b,c]]);break;case "m":b+=h[0];c+=h[1];d=e=null;f.push(["moveTo",[b,c]]);break;case "L":b=h[0];c=h[1];d=e=null;f.push(["lineTo",[b,c]]);break;case "l":b+=h[0];c+=h[1];d=e=null;f.push(["lineTo",[b,c]]);
break;case "H":b=h[0];d=e=null;f.push(["lineTo",[b,c]]);break;case "h":b+=h[0];d=e=null;f.push(["lineTo",[b,c]]);break;case "V":c=h[0];d=e=null;f.push(["lineTo",[b,c]]);break;case "v":c+=h[0];d=e=null;f.push(["lineTo",[b,c]]);break;case "C":b=h[4];c=h[5];d=h[2];e=h[3];f.push(["bezierCurveTo",h]);break;case "c":f.push(["bezierCurveTo",[h[0]+b,h[1]+c,h[2]+b,h[3]+c,h[4]+b,h[5]+c]]);d=b+h[2];e=c+h[3];b+=h[4];c+=h[5];break;case "S":if(d==null||!g.match(/[sc]/i))d=b,e=c;f.push(["bezierCurveTo",[b-(d-b),
c-(e-c),h[0],h[1],h[2],h[3]]]);d=h[0];e=h[1];b=h[2];c=h[3];break;case "s":if(d==null||!g.match(/[sc]/i))d=b,e=c;f.push(["bezierCurveTo",[b-(d-b),c-(e-c),b+h[0],c+h[1],b+h[2],c+h[3]]]);d=b+h[0];e=c+h[1];b+=h[2];c+=h[3];break;case "Q":d=h[0];e=h[1];b=h[2];c=h[3];f.push(["quadraticCurveTo",h]);break;case "q":f.push(["quadraticCurveTo",[h[0]+b,h[1]+c,h[2]+b,h[3]+c]]);d=b+h[0];e=c+h[1];b+=h[2];c+=h[3];break;case "T":d==null||!g.match(/[qt]/i)?(d=b,e=c):(d=b-(d-b),e=c-(e-c));f.push(["quadraticCurveTo",
[d,e,h[0],h[1]]]);d=b-(d-b);e=c-(e-c);b=h[0];c=h[1];break;case "t":d==null||!g.match(/[qt]/i)?(d=b,e=c):(d=b-(d-b),e=c-(e-c));f.push(["quadraticCurveTo",[d,e,b+h[0],c+h[1]]]);b+=h[0];c+=h[1];break;case "A":g=this.solveArc(b,c,h);for(b=0;b<g.length;b++)g[b][2]=i;f.push.apply(f,g);b=h[5];c=h[6];break;case "a":h[5]+=b;h[6]+=c;g=this.solveArc(b,c,h);for(b=0;b<g.length;b++)g[b][2]=i;f.push.apply(f,g);b=h[5];c=h[6];break;case "Z":f.push(["closePath",[]]);break;case "z":f.push(["closePath",[]])}g=l}return f},
solveArc:function(a,b,c){a=this.arcToSegments(c[5],c[6],c[0],c[1],c[3],c[4],c[2],a,b);b=[];for(c=0;c<a.length;c++)b.push(["bezierCurveTo",this.segmentToBezier.apply(this,a[c])]);return b},arcToSegments:function(a,b,c,d,e,g,f,i,h){var l=f*(Math.PI/180),f=Math.sin(l),l=Math.cos(l),c=Math.abs(c),d=Math.abs(d),k=l*(i-a)*0.5+f*(h-b)*0.5,m=l*(h-b)*0.5-f*(i-a)*0.5,k=k*k/(c*c)+m*m/(d*d);k>1&&(k=Math.sqrt(k),c*=k,d*=k);var n=l/c,o=f/c,m=-f/d,p=l/d,k=n*i+o*h,i=m*i+p*h,h=n*a+o*b,b=m*a+p*b,a=1/((h-k)*(h-k)+(b-
i)*(b-i))-0.25;a<0&&(a=0);a=Math.sqrt(a);g==e&&(a=-a);e=0.5*(k+h)-a*(b-i);a=0.5*(i+b)+a*(h-k);k=Math.atan2(i-a,k-e);b=Math.atan2(b-a,h-e)-k;b<0&&g==1?b+=2*Math.PI:b>0&&g==0&&(b-=2*Math.PI);g=Math.ceil(Math.abs(b/(Math.PI*0.5+0.0010)));i=[];for(h=0;h<g;h++)i[h]=[e,a,k+h*b/g,k+(h+1)*b/g,c,d,f,l];return i},segmentToBezier:function(a,b,c,d,e,g,f,i){var h=i*e,l=-f*g;e*=f;g*=i;i=0.5*(d-c);f=8/3*Math.sin(i*0.5)*Math.sin(i*0.5)/Math.sin(i);i=a+Math.cos(c)-f*Math.sin(c);c=b+Math.sin(c)+f*Math.cos(c);a+=Math.cos(d);
b+=Math.sin(d);var k=a+f*Math.sin(d),d=b-f*Math.cos(d);return[h*i+l*c,e*i+g*c,h*k+l*d,e*k+g*d,h*a+l*b,e*a+g*b]},getLength:function(){var a=this.getSegments();if(a.arcLength==null)for(var b=a.arcLength=0,c=0,d=0;d<a.length;d++){var e=a[d][1];if(!(e.length<2)){switch(a[d][0]){case "bezierCurveTo":a[d][3]=f.Curves.cubicLength([b,c],[e[0],e[1]],[e[2],e[3]],[e[4],e[5]]);break;case "quadraticCurveTo":a[d][3]=f.Curves.quadraticLength([b,c],[e[0],e[1]],[e[2],e[3]]);break;case "lineTo":a[d][3]=f.Curves.lineLength([b,
c],[e[0],e[1]])}a[d][3]&&(a.arcLength+=a[d][3]);b=e[e.length-2];c=e[e.length-1]}}return a.arcLength},pointAngleAt:function(a,b){for(var c=[],d=this.getSegments(),e=this.getLength(),g=0,j=0,i=0;i<d.length;i++){var h=d[i];h[1].length<2||(h[0]!="moveTo"&&c.push([g,j,h]),g=h[1][h[1].length-2],j=h[1][h[1].length-1])}if(c.length<1)return{point:[g,j],angle:0};if(a>=1)var k=1,h=c[c.length-1];else if(b&&b.discrete)var m=Math.floor(a*c.length),h=c[m],k=0;else if(b&&b.linear)m=a*c.length,k=m-Math.floor(m),h=
c[Math.floor(m)];else{h=a*e;for(i=d=0;i<c.length;i++){if(d+c[i][2][3]>h){m=i;k=(h-d)/c[i][2][3];break}d+=c[i][2][3]}h=c[m]}c=0;i=h[2][1];switch(h[2][0]){case "bezierCurveTo":return f.Curves.cubicLengthPointAngle([h[0],h[1]],[i[0],i[1]],[i[2],i[3]],[i[4],i[5]],k);case "quadraticCurveTo":return f.Curves.quadraticLengthPointAngle([h[0],h[1]],[i[0],i[1]],[i[2],i[3]],k);case "lineTo":g=f.Curves.linearValue(h[0],i[0],k),j=f.Curves.linearValue(h[1],i[1],k),c=f.Curves.lineAngle([h[0],h[1]],[i[0],i[1]],k)}return{point:[g,
j],angle:c}}});f.Polygon=f.Klass(f.Drawable,{segments:[],closePath:!0,initialize:function(a,b){this.segments=a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){if(this.segments&&!(this.segments.length<2)){var b=this.segments;a.moveTo(b[0],b[1]);for(var c=2;c<b.length;c+=2)a.lineTo(b[c],b[c+1]);this.closePath&&a.closePath()}},isPointInPath:function(a,b){if(!this.segments||this.segments.length<2)return!1;var c=this.getBoundingBox();return a>=c[0]&&a<=c[0]+c[2]&&b>=c[1]&&b<=c[1]+c[3]},getStartPoint:function(){if(!this.segments||
this.segments.length<2)return{point:[0,0],angle:0};var a=0;this.segments.length>2&&(a=f.Curves.lineAngle(this.segments.slice(0,2),this.segments.slice(2,4)));return{point:this.segments.slice(0,2),angle:a}},getEndPoint:function(){if(!this.segments||this.segments.length<2)return{point:[0,0],angle:0};var a=0;this.segments.length>2&&(a=f.Curves.lineAngle(this.segments.slice(-4,-2),this.segments.slice(-2)));return{point:this.segments.slice(-2),angle:a}},getMidPoints:function(){if(!this.segments||this.segments.length<
2)return[];for(var a=this.segments,b=[],c=2;c<a.length-2;c+=2){var d=a.slice(c-2,c),e=a.slice(c,c+2),g=a.slice(c+2,c+4),d=0.5*(Curves.lineAngle(d,e)+f.Curves.lineAngle(e,g));b.push({point:e,angle:d})}return b},getBoundingBox:function(){for(var a=Infinity,b=Infinity,c=-Infinity,d=-Infinity,e=this.segments,g=0;g<e.length;g+=2){var f=e[g],i=e[g+1];f<a&&(a=f);f>c&&(c=f);i<b&&(b=i);i>d&&(d=i)}return[a,b,c-a,d-b]}});f.Rectangle=f.Klass(f.Drawable,{cx:0,cy:0,x2:0,y2:0,width:0,height:0,rx:0,ry:0,centered:!1,
initialize:function(a,b,c){if(a!=null)this.height=this.width=a;if(b!=null)this.height=b;f.Drawable.initialize.call(this,c)},drawGeometry:function(a){var b=this.cx,c=this.cy,d=this.width||this.x2-b,e=this.height||this.y2-c;if(!(d==0||e==0))if(this.centered&&(b-=0.5*d,c-=0.5*e),this.rx||this.ry){var g=Math.min(d*0.5,this.rx||this.ry),f=Math.min(e*0.5,this.ry||g),i=0.5522847498*g,h=0.5522847498*f;a.moveTo(b+g,c);a.lineTo(b-g+d,c);a.bezierCurveTo(b-g+d+i,c,b+d,c+f-h,b+d,c+f);a.lineTo(b+d,c+e-f);a.bezierCurveTo(b+
d,c+e-f+h,b-g+d+i,c+e,b-g+d,c+e);a.lineTo(b+g,c+e);a.bezierCurveTo(b+g-i,c+e,b,c+e-f+h,b,c+e-f);a.lineTo(b,c+f);a.bezierCurveTo(b,c+f-h,b+g-i,c,b+g,c);a.closePath()}else d<0&&(b+=d),e<0&&(c+=e),a.rect(b,c,Math.abs(d),Math.abs(e))},isPointInPath:function(a,b){a-=this.cx;b-=this.cy;this.centered&&(a+=this.width/2,b+=this.height/2);return a>=0&&a<=this.width&&b>=0&&b<=this.height},getBoundingBox:function(){var a=this.cx,b=this.cy;this.centered&&(a-=this.width/2,b-=this.height/2);return[a,b,this.width,
this.height]}});f.Spiral=f.Klass(f.Drawable,{cx:0,cy:0,startRadius:0,startAngle:0,endAngle:0,radiusFunction:function(a){return a},initialize:function(a,b){this.endAngle=a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){var b=this.cx,c=this.cy,d=this.startAngle,e=this.startRadius+this.radiusFunction(d);a.moveTo(b+Math.cos(d)*e,c-Math.sin(d)*e);if(this.startAngle<this.endAngle){d+=0.1;for(e=this.startRadius+this.radiusFunction(d);d<this.endAngle;)a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*
e),d+=0.1,e=this.startRadius+this.radiusFunction(d)}else{d-=0.1;for(e=this.startRadius+this.radiusFunction(d);d>this.endAngle;)a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e),d-=0.1,e=this.startRadius+this.radiusFunction(d)}d=this.endAngle;e=this.startRadius+this.radiusFunction(d);a.lineTo(b+Math.cos(d)*e,c-Math.sin(d)*e)},isPointInPath:function(){return!1}});f.TextNode=f.Klass(f.Drawable,{text:"Text",align:"start",baseline:"alphabetic",accuratePicking:!1,asPath:!1,pathGeometry:null,maxWidth:null,width:0,
height:20,cx:0,cy:0,__drawMethodName:"draw"+f.CanvasSupport.getTextBackend(),__pickingMethodName:"drawPickingPath"+f.CanvasSupport.getTextBackend(),initialize:function(a,b){this.lastText=this.text;this.text=a;f.Drawable.initialize.call(this,b)},drawGeometry:function(a){this.drawUsing(a,this.__drawMethodName)},drawPickingPath:function(a){this.drawUsing(a,this.__pickingMethodName)},drawUsing:function(a,b){if(this.text&&this.text.length!=0){if(this.lastText!=this.text||this.lastStyle!=a.font)this.dimensions=
this.measureText(a),this.lastText=this.text,this.lastStyle=a.font;if(this[b])this[b](a)}},measureText:function(a){var b="measureText"+f.CanvasSupport.getTextBackend().capitalize();return this[b]?this[b](a):{width:0,height:0}},computeXForAlign:function(){if(this.align=="left")return 0;else if(this.align=="right")return-this.dimensions.width;else if(this.align=="center")return-this.dimensions.width*0.5},measureTextHTML5:function(a){return{width:a.measureText(this.text).width,height:20}},drawHTML5:function(a){a.fillText(this.text,
this.cx,this.cy,this.maxWidth)},drawPickingPathHTML5:function(a){a.rect(this.cx,this.cy-15,this.dimensions.width,this.dimensions.height)},measureTextMozText:function(a){return{width:a.mozMeasureText(this.text),height:20}},drawMozText:function(a){var b=this.cx+this.computeXForAlign(),c=this.cy+0;this.pathGeometry?(this.pathGeometry.draw(a),a.mozDrawTextAlongPath(this.text,this.path)):(a.save(),a.translate(b,c),this.asPath?a.mozPathText(this.text):a.mozDrawText(this.text),a.restore())},drawPickingPathMozText:function(a){var b=
this.cx+this.computeXForAlign(),c=this.cy+0;this.pathGeometry?this.pathGeometry.draw(a):this.accuratePicking?(a.save(),a.translate(b,c),a.mozPathText(this.text),a.restore()):a.rect(b,c-15,this.dimensions.width,this.dimensions.height)},drawDrawString:function(a){var b=this.cx+this.computeXForAlign();a.drawString(b,this.cy+0,this.text)},measureTextPerfectWorld:function(a){return a.measureText(this.text)},drawPerfectWorld:function(a){this.pathGeometry?(this.pathGeometry.draw(a),this.asPath?a.pathTextAlongPath(this.text):
a.drawTextAlongPath(this.text)):this.asPath?a.pathText(this.text):a.drawText(this.text)},drawPickingPathPerfectWorld:function(a){this.accuratePicking?this.pathGeometry?a.pathTextAlongPath(this.text):a.pathText(this.text):this.pathGeometry?a.textRectAlongPath(this.text):a.textRect(this.text)}});k.CakeJS=f})(window);
